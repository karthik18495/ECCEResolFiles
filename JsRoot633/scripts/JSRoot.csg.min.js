JSROOT.define(["three"],function(r){function g(a,b,c,d,e,f){this.x=a;this.y=b;this.z=c;this.nx=d;this.ny=e;this.nz=f}function p(a){this.vertices=a||[];this.nsign=1;0<this.vertices.length&&this.calculateProperties()}function m(a,b){this.polygons=[];this.front=this.back=void 0;if(a){this.divider=a[0].clone();for(var c=a.length,d=[],e=[],f=0;f<c;++f)void 0!==b&&(a[f].id=b++,delete a[f].parent),this.divider.splitPolygon(a[f],this.polygons,this.polygons,d,e);void 0!==b&&(this.maxnodeid=b);0<d.length&&
(this.front=new m(d));0<e.length&&(this.back=new m(e))}}function n(a,b,c,d){if(a instanceof r.Mesh)a.updateMatrix(),b=this.matrix=a.matrix.clone(),a=a.geometry;else{if(a instanceof m)return this.tree=a,this.matrix=null,this;if(a instanceof r.BufferGeometry){var e=a.getAttribute("position").array;a=a.getAttribute("normal").array;for(var f=[],q,h,l,t,k=0;k<e.length;k+=9)q=new p,h=new g(e[k],e[k+1],e[k+2],a[k],a[k+1],a[k+2]),b&&h.applyMatrix4(b),l=new g(e[k+3],e[k+4],e[k+5],a[k+3],a[k+4],a[k+5]),b&&
l.applyMatrix4(b),t=new g(e[k+6],e[k+7],e[k+8],a[k+6],a[k+7],a[k+8]),b&&t.applyMatrix4(b),d?q.vertices.push(h,t,l):q.vertices.push(h,l,t),q.calculateProperties(),f.push(q);this.tree=new m(f,c);void 0!==c&&(this.maxid=this.tree.maxnodeid);return this}if(a.polygons&&a.polygons[0]instanceof p){a=a.polygons;for(d=0;d<a.length;++d){e=a[d];if(b)for(f=0;f<e.vertices.length;++f)e.vertices[f].applyMatrix4(b);e.calculateProperties()}this.tree=new m(a,c);void 0!==c&&(this.maxid=this.tree.maxnodeid);return this}throw Error("ThreeBSP: Given geometry is unsupported");
}d=[];e=a.faces.length;for(k=0;k<e;++k)f=a.faces[k],l=f.normal,q=new p,t=f.vertexNormals&&3==f.vertexNormals.length,h=a.vertices[f.a],t&&(l=f.vertexNormals[0]),h=new g(h.x,h.y,h.z,l.x,l.y,l.z),b&&h.applyMatrix4(b),q.vertices.push(h),h=a.vertices[f.b],t&&(l=f.vertexNormals[1]),h=new g(h.x,h.y,h.z,l.x,l.y,l.z),b&&h.applyMatrix4(b),q.vertices.push(h),h=a.vertices[f.c],t&&(l=f.vertexNormals[2]),h=new g(h.x,h.y,h.z,l.x,l.y,l.z),b&&h.applyMatrix4(b),q.vertices.push(h),q.calculateProperties(),d.push(q);
this.tree=new m(d,c);void 0!==c&&(this.maxid=this.tree.maxnodeid)}g.prototype.setnormal=function(a,b,c){this.nx=a;this.ny=b;this.nz=c};g.prototype.clone=function(){return new g(this.x,this.y,this.z,this.nx,this.ny,this.nz)};g.prototype.add=function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;return this};g.prototype.subtract=function(a){this.x-=a.x;this.y-=a.y;this.z-=a.z;return this};g.prototype.multiplyScalar=function(a){this.x*=a;this.y*=a;this.z*=a;return this};g.prototype.cross=function(a){var b=
this.x,c=this.y,d=this.z;this.x=c*a.z-d*a.y;this.y=d*a.x-b*a.z;this.z=b*a.y-c*a.x;return this};g.prototype.normalize=function(){var a=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);this.x/=a;this.y/=a;this.z/=a;return this};g.prototype.dot=function(a){return this.x*a.x+this.y*a.y+this.z*a.z};g.prototype.diff=function(a){var b=this.x-a.x,c=this.y-a.y;a=this.z-a.z;var d=this.x*this.x+this.y*this.y+this.z*this.z;return(b*b+c*c+a*a)/(0<d?d:1E-10)};g.prototype.interpolate=function(a,b){var c=1-b;
return new g(this.x*c+a.x*b,this.y*c+a.y*b,this.z*c+a.z*b,this.nx*c+a.nx*b,this.ny*c+a.ny*b,this.nz*c+a.nz*b)};g.prototype.applyMatrix4=function(a){var b=this.x,c=this.y,d=this.z;a=a.elements;this.x=a[0]*b+a[4]*c+a[8]*d+a[12];this.y=a[1]*b+a[5]*c+a[9]*d+a[13];this.z=a[2]*b+a[6]*c+a[10]*d+a[14];b=this.nx;c=this.ny;d=this.nz;this.nx=a[0]*b+a[4]*c+a[8]*d;this.ny=a[1]*b+a[5]*c+a[9]*d;this.nz=a[2]*b+a[6]*c+a[10]*d;return this};p.prototype.copyProperties=function(a,b){this.normal=a.normal;this.w=a.w;this.nsign=
a.nsign;b&&void 0!==a.id&&(this.id=a.id,this.parent=a);return this};p.prototype.calculateProperties=function(){if(!this.normal){var a=this.vertices[0],b=this.vertices[1],c=this.vertices[2];this.nsign=1;this.normal=b.clone().subtract(a).cross(c.clone().subtract(a)).normalize();this.w=this.normal.clone().dot(a);return this}};p.prototype.clone=function(){for(var a=this.vertices.length,b=new p,c=0;c<a;++c)b.vertices.push(this.vertices[c].clone());return b.copyProperties(this)};p.prototype.flip=function(){this.nsign*=
-1;this.vertices.reverse();return this};p.prototype.classifyVertex=function(a){a=this.nsign*(this.normal.dot(a)-this.w);return-1E-5>a?2:1E-5<a?1:0};p.prototype.classifySide=function(a){var b,c=0,d=0,e=a.vertices.length;for(b=0;b<e;++b){var f=this.classifyVertex(a.vertices[b]);1===f?++c:2===f&&++d}return 0<c&&0===d?1:0===c&&0<d?2:0===c&&0===d?0:3};p.prototype.splitPolygon=function(a,b,c,d,e){var f=this.classifySide(a);if(0===f)(0<this.nsign*a.nsign*this.normal.dot(a.normal)?b:c).push(a);else if(1===
f)d.push(a);else if(2===f)e.push(a);else{b=a.vertices.length;c=this.normal.x;f=this.normal.y;var q=this.normal.z,h,l=[],g=[];for(h=0;h<b;++h){var k=(h+1)%b;var m=a.vertices[h];k=a.vertices[k];var n=this.classifyVertex(m);var r=this.classifyVertex(k);2!=n&&l.push(m);1!=n&&g.push(m);3===(n|r)&&(n=(this.w-(c*m.x+f*m.y+q*m.z))/(c*(k.x-m.x)+f*(k.y-m.y)+q*(k.z-m.z)),m=m.interpolate(k,n),l.push(m),g.push(m))}3<=l.length&&d.push((new p(l)).copyProperties(a,!0));3<=g.length&&e.push((new p(g)).copyProperties(a,
!0))}};m.isConvex=function(a){var b,c,d=a.length;for(b=0;b<d;++b)for(c=0;c<d;++c)if(b!==c&&2!==a[b].classifySide(a[c]))return!1;return!0};m.prototype.build=function(a){var b=a.length,c=[],d=[];this.divider||(this.divider=a[0].clone());for(var e=0;e<b;++e)this.divider.splitPolygon(a[e],this.polygons,this.polygons,c,d);0<c.length&&(this.front||(this.front=new m),this.front.build(c));0<d.length&&(this.back||(this.back=new m),this.back.build(d))};m.prototype.collectPolygons=function(a){for(var b=this.polygons.length,
c=0;c<b;++c)a.push(this.polygons[c]);this.front&&this.front.collectPolygons(a);this.back&&this.back.collectPolygons(a);return a};m.prototype.allPolygons=function(){var a=this.polygons.slice();this.front&&(a=a.concat(this.front.allPolygons()));this.back&&(a=a.concat(this.back.allPolygons()));return a};m.prototype.numPolygons=function(){var a=this.polygons.length;this.front&&(a+=this.front.numPolygons());this.back&&(a+=this.back.numPolygons());return a};m.prototype.clone=function(){var a=new m;a.divider=
this.divider.clone();a.polygons=this.polygons.map(function(a){return a.clone()});a.front=this.front&&this.front.clone();a.back=this.back&&this.back.clone();return a};m.prototype.invert=function(){for(var a=this.polygons.length,b=0;b<a;++b)this.polygons[b].flip();this.divider.flip();this.front&&this.front.invert();this.back&&this.back.invert();a=this.front;this.front=this.back;this.back=a;return this};m.prototype.clipPolygons=function(a){if(!this.divider)return a.slice();for(var b=a.length,c=[],d=
[],e=0;e<b;++e)this.divider.splitPolygon(a[e],c,d,c,d);this.front&&(c=this.front.clipPolygons(c));d=this.back?this.back.clipPolygons(d):[];return c.concat(d)};m.prototype.clipTo=function(a){this.polygons=a.clipPolygons(this.polygons);this.front&&this.front.clipTo(a);this.back&&this.back.clipTo(a)};var v=function(a){function b(a){f[h]=a.x;f[h+1]=a.y;f[h+2]=a.z;g[h]=l.nsign*a.nx;g[h+1]=l.nsign*a.ny;g[h+2]=l.nsign*a.nz;h+=3}var c,d,e=a.length;for(c=d=0;c<e;++c)d+=9*(a[c].vertices.length-2);var f=new Float32Array(d),
g=new Float32Array(d),h=0;for(c=0;c<e;++c){var l=a[c];for(d=2;d<l.vertices.length;++d)b(l.vertices[0]),b(l.vertices[d-1]),b(l.vertices[d])}a=new r.BufferGeometry;a.setAttribute("position",new r.BufferAttribute(f,3));a.setAttribute("normal",new r.BufferAttribute(g,3));return a};n.prototype.subtract=function(a){var b=this.tree.clone();a=a.tree.clone();b.invert();b.clipTo(a);a.clipTo(b);a.invert();a.clipTo(b);a.invert();b.build(a.allPolygons());b.invert();b=new n(b);b.matrix=this.matrix;return b};n.prototype.union=
function(a){var b=this.tree.clone();a=a.tree.clone();b.clipTo(a);a.clipTo(b);a.invert();a.clipTo(b);a.invert();b.build(a.allPolygons());b=new n(b);b.matrix=this.matrix;return b};n.prototype.intersect=function(a){var b=this.tree.clone();a=a.tree.clone();b.invert();a.clipTo(b);a.invert();b.clipTo(a);a.clipTo(b);b.build(a.allPolygons());b.invert();b=new n(b);b.matrix=this.matrix;return b};n.prototype.tryToCompress=function(a){if(void 0!==this.maxid){var b=[],c,d=0,e,f=a.length,g,h,l,m;for(e=0;e<f;++e){var k=
a[e];void 0!==k.id&&(void 0===b[k.id]&&(b[k.id]=[]),b[k.id].push(k))}for(e=0;e<b.length;++e)if(k=b[e],void 0!==k)for(f=k.length,c=1<f;c;)for(c=!1,l=0;l<f-1;++l)if((g=k[l])&&g.parent)for(m=l+1;m<f;++m)if((h=k[m])&&g.parent===h.parent&&g.nsign===h.nsign){g.nsign!==g.parent.nsign&&g.parent.flip();d++;k[l]=g.parent;k[m]=null;3>g.parent.vertices.length&&console.log("something wrong with parent");c=!0;break}if(0<d)for(a.splice(0,a.length),e=0;e<b.length;++e)if(k=b[e],void 0!==k)for(l=0,f=k.length;l<f;++l)k[l]&&
a.push(k[l])}};n.prototype.direct_subtract=function(a){var b=this.tree;a=a.tree;b.invert();b.clipTo(a);a.clipTo(b);a.invert();a.clipTo(b);a.invert();b.build(a.collectPolygons([]));b.invert();return this};n.prototype.direct_union=function(a){var b=this.tree;a=a.tree;b.clipTo(a);a.clipTo(b);a.invert();a.clipTo(b);a.invert();b.build(a.collectPolygons([]));return this};n.prototype.direct_intersect=function(a){var b=this.tree;a=a.tree;b.invert();a.clipTo(b);a.invert();b.clipTo(a);a.clipTo(b);b.build(a.collectPolygons([]));
b.invert();return this};n.prototype.cut_from_plane=function(a){var b=this.tree;a=a.tree;b.invert();a.clipTo(b);return this};n.prototype.scale=function(a,b,c){for(var d=this.tree.collectPolygons([]),e=0;e<d.length;++e){for(var f=d[e],g=0;g<f.vertices.length;++g){var h=f.vertices[g];h.x*=a;h.y*=b;h.z*=c}delete f.normal;f.calculateProperties()}};n.prototype.toPolygons=function(){var a=this.tree.collectPolygons([]);this.tryToCompress(a);for(var b=0;b<a.length;++b)delete a[b].id,delete a[b].parent;return a};
n.prototype.toBufferGeometry=function(){return v(this.toPolygons())};n.prototype.toMesh=function(a){var b=this.toBufferGeometry();a=new r.Mesh(b,a);this.matrix&&(a.position.setFromMatrixPosition(this.matrix),a.rotation.setFromRotationMatrix(this.matrix));return a};var u={CreateNormal:function(a,b,c){if(!c||1E4>c)c=1E4;switch(a){case "x":var d=new g(b,-3*c,c,1,0,0);var e=new g(b,c,c,1,0,0);var f=new g(b,c,-3*c,1,0,0);break;case "y":d=new g(-3*c,b,c,0,1,0);f=new g(c,b,c,0,1,0);e=new g(c,b,-3*c,0,1,
0);break;case "z":d=new g(-3*c,c,b,0,0,1),e=new g(c,c,b,0,0,1),f=new g(c,-3*c,b,0,0,1)}a=new p([d,f,e]);a.calculateProperties();a=new m([a]);return new n(a)}};u.Vertex=g;u.Geometry=n;u.Polygon=p;u.CreateBufferGeometry=v;JSROOT.nodejs&&(module.exports=u);return u});
