var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(f,y,v){f!=Array.prototype&&f!=Object.prototype&&(f[y]=v.value)};$jscomp.getGlobal=function(f){return"undefined"!=typeof window&&window===f?f:"undefined"!=typeof global&&null!=global?global:f};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(f,y,v,A){if(y){v=$jscomp.global;f=f.split(".");for(A=0;A<f.length-1;A++){var nb=f[A];nb in v||(v[nb]={});v=v[nb]}f=f[f.length-1];A=v[f];y=y(A);y!=A&&null!=y&&$jscomp.defineProperty(v,f,{configurable:!0,writable:!0,value:y})}};$jscomp.polyfill("Number.isFinite",function(f){return f?f:function(f){return"number"!==typeof f?!1:!isNaN(f)&&Infinity!==f&&-Infinity!==f}},"es6","es3");
$jscomp.polyfill("Number.isInteger",function(f){return f?f:function(f){return Number.isFinite(f)?f===Math.floor(f):!1}},"es6","es3");
JSROOT.define(["three","csg"],function(f,y){function v(a){this.nfaces=a;this.indx=0;this.pos=new Float32Array(9*a);this.norm=new Float32Array(9*a);return this}function A(){this.polygons=[]}function nb(a,b){var c=[4,7,6,5,0,3,7,4,4,5,1,0,6,2,1,5,7,3,2,6,1,2,3,0];b=0<b?new A:new v(12);for(var d=0;d<c.length;d+=4){var e=3*c[d],g=3*c[d+1],n=3*c[d+2],h=3*c[d+3];b.addFace4(a[e],a[e+1],a[e+2],a[g],a[g+1],a[g+2],a[n],a[n+1],a[n+2],a[h],a[h+1],a[h+2]);0===d?b.setNormal(0,0,1):20===d?b.setNormal(0,0,-1):b.calcNormal()}return b.create()}
function Td(a,b){if("TGeoCone"==a._typename||"TGeoConeSeg"==a._typename){var c=[a.fRmax2,a.fRmax1];var d=[a.fRmin2,a.fRmin1]}else c=[a.fRmax,a.fRmax],d=[a.fRmin,a.fRmin];var e=0<d[0]||0<d[1],g=0,n=360;if("TGeoConeSeg"==a._typename||"TGeoTubeSeg"==a._typename||"TGeoCtub"==a._typename)g=a.fPhi1,n=a.fPhi2-a.fPhi1;var h=Math.max(4,Math.round(n/k.GradPerSegm)),f=h*(0>=c[0]||0>=c[1]?1:2);e&&(f+=h*(0>=d[0]||0>=d[1]?1:2));0<c[0]&&(f+=h*(0<d[0]?2:1));0<c[1]&&(f+=h*(0<d[1]?2:1));360>n&&(f+=(c[0]>d[0]?2:0)+
(c[1]>d[1]?2:0));if(0>b)return f;var l=g*Math.PI/180,m=n/h*Math.PI/180;g=new Float32Array(h+1);for(var r=new Float32Array(h+1),u=0;u<=h;++u)r[u]=Math.cos(l+u*m),g[u]=Math.sin(l+u*m);b=b?new A:new v(f);var x;"TGeoCtub"==a._typename&&(x=function(b,c,d){var e=0>d?a.fNlow:a.fNhigh;return(0>d?-a.fDz:a.fDz)-(b*e[0]+c*e[1])/e[2]});for(f=0;2>f&&(1!==f||e);++f){l=0===f?c:d;m=f;u=1-f;var w=1,oa=0;l[0]!==l[1]&&(oa=Math.atan2(l[1]-l[0],2*a.fDZ),w=Math.cos(oa),oa=Math.sin(oa));1===f&&(w*=-1,oa*=-1);var q=0;0>=
l[0]?q=2:0>=l[1]&&(q=1);for(var p=0;p<h;++p)b.addFace4(l[0]*r[p+m],l[0]*g[p+m],a.fDZ,l[1]*r[p+m],l[1]*g[p+m],-a.fDZ,l[1]*r[p+u],l[1]*g[p+u],-a.fDZ,l[0]*r[p+u],l[0]*g[p+u],a.fDZ,q),x&&b.recalcZ(x),b.setNormal_12_34(w*r[p+m],w*g[p+m],oa,w*r[p+u],w*g[p+u],oa,q)}for(e=0;2>e;++e)if(!(0>=c[e])){f=e;l=1-e;m=0==e?1:-1;u=0>=d[e]?2:0;2!=u||360!==n||x||b.startPolygon(0===e);for(w=0;w<h;++w)b.addFace4(d[e]*r[w+f],d[e]*g[w+f],m*a.fDZ,c[e]*r[w+f],c[e]*g[w+f],m*a.fDZ,c[e]*r[w+l],c[e]*g[w+l],m*a.fDZ,d[e]*r[w+l],
d[e]*g[w+l],m*a.fDZ,u),x?(b.recalcZ(x),b.calcNormal()):b.setNormal(0,0,m);b.stopPolygon()}360>n&&(b.addFace4(d[1]*r[0],d[1]*g[0],-a.fDZ,c[1]*r[0],c[1]*g[0],-a.fDZ,c[0]*r[0],c[0]*g[0],a.fDZ,d[0]*r[0],d[0]*g[0],a.fDZ,c[0]===d[0]?2:d[1]===c[1]?1:0),x&&b.recalcZ(x),b.calcNormal(),b.addFace4(d[0]*r[h],d[0]*g[h],a.fDZ,c[0]*r[h],c[0]*g[h],a.fDZ,c[1]*r[h],c[1]*g[h],-a.fDZ,d[1]*r[h],d[1]*g[h],-a.fDZ,c[0]===d[0]?1:d[1]===c[1]?2:0),x&&b.recalcZ(x),b.calcNormal());return b.create()}function Tb(a,b){if(!a||!a.fN||
!a.fP)return null;var c=new f.Vector3(a.fP[0],a.fP[1],a.fP[2]);a=new f.Vector3(a.fN[0],a.fN[1],a.fN[2]);a.normalize();var d=1E10;if(b){if(b){var e=null;b instanceof y.Geometry?e=b.tree.collectPolygons([]):b.polygons&&(e=b.polygons);if(null!==e){b=new f.Box3;for(var g=0;g<e.length;++g)for(var n=e[g],h=n.vertices.length,k=0;k<h;++k)b.expandByPoint(n.vertices[k]);e=b}else b.boundingBox||b.computeBoundingBox(),e=b.boundingBox.clone()}else e=null;e&&(d=1E3*e.getSize(new f.Vector3).length())}e=new f.Vector3(-d,
-d/2,0);b=new f.Vector3(0,d,0);g=new f.Vector3(d,-d/2,0);n=new f.Vector3(0,0,-d);d=new f.BufferGeometry;e=new Float32Array([e.x,e.y,e.z,g.x,g.y,g.z,b.x,b.y,b.z,e.x,e.y,e.z,b.x,b.y,b.z,n.x,n.y,n.z,b.x,b.y,b.z,g.x,g.y,g.z,n.x,n.y,n.z,g.x,g.y,g.z,e.x,e.y,e.z,n.x,n.y,n.z]);d.setAttribute("position",new f.BufferAttribute(e,3));d.computeVertexNormals();d.lookAt(a);d.computeVertexNormals();for(a=0;a<e.length;a+=3)e[a]+=c.x,e[a+1]+=c.y,e[a+2]+=c.z;return d}function Y(a){return a?a instanceof y.Geometry?a.tree.numPolygons():
"BufferGeometry"==a.type?(a=a.getAttribute("position"))&&a.count?Math.round(a.count/3):0:a.polygons?a.polygons.length:a.faces.length:0}function He(a,b){if(0>b)return Ia(a.fNode.fLeft,-10)+Ia(a.fNode.fRight,-10);var c=!1,d=k.createMatrix(a.fNode.fLeftMat);var e=k.createMatrix(a.fNode.fRightMat);0===b?b=4E3:c=!0;d&&-.9>d.determinant()&&k.warn("Axis reflection in left composite shape - not supported");e&&-.9>e.determinant()&&k.warn("Axis reflections in right composite shape - not supported");var g="TGeoHalfSpace"==
a.fNode.fLeft._typename?Tb(a.fNode.fLeft):Ia(a.fNode.fLeft,b);if(!g)return null;var n=Y(g),h=0;g._exceed_limit&&(n+=b);if(n<b){var f="TGeoHalfSpace"==a.fNode.fRight._typename?Tb(a.fNode.fRight,g):Ia(a.fNode.fRight,b);h=Y(f)}if(n+h>=b||!f)return g.polygons&&(g=y.CreateBufferGeometry(g.polygons)),d&&g.applyMatrix4(d),g._exceed_limit=!0,g;b=new y.Geometry(g,d,k.CompressComp?0:void 0);e=new y.Geometry(f,e,b.maxid);b.maxid=e.maxid;switch(a.fNode._typename){case "TGeoIntersection":b.direct_intersect(e);
break;case "TGeoUnion":b.direct_union(e);break;case "TGeoSubtraction":b.direct_subtract(e);break;default:k.warn("unsupported bool operation "+a.fNode._typename+", use first geom")}0===Y(b)&&(k.warn("Zero faces in comp shape left: "+a.fNode.fLeft._typename+" "+Y(g)+" faces right: "+a.fNode.fRight._typename+" "+Y(f)+" faces  use first"),b=new y.Geometry(g,d));return c?{polygons:b.toPolygons()}:b.toBufferGeometry()}function Ub(a){var b=[],c=null;void 0!==a.fVolume?c=a.fVolume.fShape:void 0!==a.fShape?
c=a.fShape:void 0!==a.fShapeBits&&void 0!==a.fShapeId&&(c=a);if(!c)return b.push(a._typename),b;a=Math.max(c.fDX,c.fDY,c.fDZ);var d=1E7<a||1E-7>a;a=function(a){return void 0===a?"???":a==Math.round(a)&&1E7>a?Math.round(a):d?a.toExponential(4):a.toPrecision(7)};b.push(c._typename);b.push("DX="+a(c.fDX)+" DY="+a(c.fDY)+" DZ="+a(c.fDZ));switch(c._typename){case "TGeoPara":b.push("Alpha="+c.fAlpha+" Phi="+c.fPhi+" Theta="+c.fTheta);break;case "TGeoTrd2":b.push("Dy1="+a(c.fDy1)+" Dy2="+a(c.fDy1));case "TGeoTrd1":b.push("Dx1="+
a(c.fDx1)+" Dx2="+a(c.fDx1));break;case "TGeoSphere":b.push("Rmin="+a(c.fRmin)+" Rmax="+a(c.fRmax));b.push("Phi1="+c.fPhi1+" Phi2="+c.fPhi2);b.push("Theta1="+c.fTheta1+" Theta2="+c.fTheta2);break;case "TGeoConeSeg":b.push("Phi1="+c.fPhi1+" Phi2="+c.fPhi2);case "TGeoCone":b.push("Rmin1="+a(c.fRmin1)+" Rmax1="+a(c.fRmax1));b.push("Rmin2="+a(c.fRmin2)+" Rmax2="+a(c.fRmax2));break;case "TGeoCtub":case "TGeoTubeSeg":b.push("Phi1="+c.fPhi1+" Phi2="+c.fPhi2);case "TGeoEltu":case "TGeoTube":b.push("Rmin="+
a(c.fRmin)+" Rmax="+a(c.fRmax));break;case "TGeoTorus":b.push("Rmin="+a(c.fRmin)+" Rmax="+a(c.fRmax));b.push("Phi1="+c.fPhi1+" Dphi="+c.fDphi);break;case "TGeoParaboloid":b.push("Rlo="+a(c.fRlo)+" Rhi="+a(c.fRhi));b.push("A="+a(c.fA)+" B="+a(c.fB));break;case "TGeoHype":b.push("Rmin="+a(c.fRmin)+" Rmax="+a(c.fRmax));b.push("StIn="+a(c.fStIn)+" StOut="+a(c.fStOut));break;case "TGeoScaledShape":b=Ub(c.fShape),c.fScale&&b.unshift("Scale X="+c.fScale.fScale[0]+" Y="+c.fScale.fScale[1]+" Z="+c.fScale.fScale[2])}return b}
function Vb(a){var b=new f.Matrix4;a.updateMatrixWorld();a.matrixWorldInverse.copy(a.matrixWorld).invert();b.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse);return b}function t(a,b){this.toplevel=!0;this.name_prefix="";this.maxdepth=1;this.vislevel=4;this.maxnodes=1E4;a?(a.$geoh&&(this.toplevel=!1),this.createClones(a)):b&&(this.nodes=b)}function Wb(a,b){var c=new f.Vector3(1,1,-1);if(void 0===a.geomZ)if("BufferGeometry"==a.geom.type){var d=a.geom.getAttribute("position").array,e=a.geom.getAttribute("normal").array,
g=a.geom.getIndex();if(g){g=g.array;var n=a.geom.drawRange.start,h=a.geom.drawRange.count;n+h>g.length&&(h=g.length-n);for(var k=new Float32Array(3*h),l=new Float32Array(3*h),m=0;m<h;++m){var r=g[n+m];(0>r||3*r>=d.length)&&console.log("strange index",3*r,d.length);k[3*m]=d[3*r];k[3*m+1]=d[3*r+1];k[3*m+2]=d[3*r+2];l[3*m]=e[3*r];l[3*m+1]=e[3*r+1];l[3*m+2]=e[3*r+2]}d=k;e=l}g=d.length;h=0;k=new Float32Array(g);l=new Float32Array(g);for(n=0;n<g;n+=3)k[n]=d[n+h],k[n+1]=d[n+1+h],k[n+2]=-d[n+2+h],l[n]=e[n+
h],l[n+1]=e[n+1+h],l[n+2]=-e[n+2+h],h+=3,6===h&&(h=-3);a.geomZ=new f.BufferGeometry;a.geomZ.setAttribute("position",new f.BufferAttribute(k,3));a.geomZ.setAttribute("normal",new f.BufferAttribute(l,3))}else for(a.geomZ=a.geom.clone(),a.geomZ.scale(c.x,c.y,c.z),g=0;g<a.geomZ.faces.length;)d=geom.faces[g++],e=d.b,d.b=d.c,d.c=e;a=new f.Mesh(a.geomZ,b);a.scale.copy(c);a.updateMatrix();a._flippedMesh=!0;return a}function Xb(a,b,c){if(!a||!a.geometry)return b;b||(b=new f.Box3,b.makeEmpty());c||a.updateMatrixWorld();
var d=new f.Vector3,e=a.geometry;if(e.isGeometry){e=e.vertices;for(var g=0,n=e.length;g<n;g++)d.copy(e[g]),c||d.applyMatrix4(a.matrixWorld),b.expandByPoint(d)}else if(e.isBufferGeometry&&(e=e.attributes.position,void 0!==e))for(g=0,n=e.count;g<n;g++)d.fromBufferAttribute(e,g),c||d.applyMatrix4(a.matrixWorld),b.expandByPoint(d);return b}var k={GradPerSegm:6,CompressComp:!0,CompLimit:20};k.BITS={kVisOverride:JSROOT.BIT(0),kVisNone:JSROOT.BIT(1),kVisThis:JSROOT.BIT(2),kVisDaughters:JSROOT.BIT(3),kVisOneLevel:JSROOT.BIT(4),
kVisStreamed:JSROOT.BIT(5),kVisTouched:JSROOT.BIT(6),kVisOnScreen:JSROOT.BIT(7),kVisContainers:JSROOT.BIT(12),kVisOnly:JSROOT.BIT(13),kVisBranch:JSROOT.BIT(14),kVisRaytrace:JSROOT.BIT(15)};k.TestBit=function(a,b){a=a.fGeoAtt;return void 0===a?!1:0!==(a&b)};k.SetBit=function(a,b,c){void 0!==a.fGeoAtt&&(a.fGeoAtt=c?a.fGeoAtt|b:a.fGeoAtt&~b)};k.ToggleBit=function(a,b){void 0!==a.fGeoAtt&&(a.fGeoAtt^=b&16777215)};k.setInvisibleAll=function(a,b){void 0===b&&(b=!0);k.SetBit(a,k.BITS.kVisThis,!b);if(a.fNodes)for(var c=
0;c<a.fNodes.arr.length;++c)k.SetBit(a.fNodes.arr[c].fVolume,k.BITS.kVisThis,!b)};k.warn=function(a){void 0===k._warn_msgs&&(k._warn_msgs={});void 0===k._warn_msgs[a]&&(k._warn_msgs[a]=!0,console.warn(a))};k.getNodeKind=function(a){return void 0===a||null===a||"object"!==typeof a?-1:"fShape"in a&&"fTrans"in a?1:0};k.countNumShapes=function(a){return a?"TGeoCompositeShape"!==a._typename?1:k.countNumShapes(a.fNode.fLeft)+k.countNumShapes(a.fNode.fRight):0};k.produceNormal=function(a,b,c,d,e,g,n,h,k){a=
new f.Vector3(a,b,c);d=new f.Vector3(d,e,g);n=new f.Vector3(n,h,k);h=new f.Vector3;k=new f.Vector3;h.subVectors(n,d);k.subVectors(a,d);h.cross(k);return h};v.prototype.addFace3=function(a,b,c,d,e,g,n,f,k){var h=this.indx,m=this.pos;m[h]=a;m[h+1]=b;m[h+2]=c;m[h+3]=d;m[h+4]=e;m[h+5]=g;m[h+6]=n;m[h+7]=f;m[h+8]=k;this.last4=!1;this.indx=h+9};v.prototype.startPolygon=function(){};v.prototype.stopPolygon=function(){};v.prototype.addFace4=function(a,b,c,d,e,g,n,h,f,l,k,r,u){var x=this.indx,m=this.pos;1!==
u&&(m[x]=a,m[x+1]=b,m[x+2]=c,m[x+3]=d,m[x+4]=e,m[x+5]=g,m[x+6]=n,m[x+7]=h,m[x+8]=f,x+=9);2!==u&&(m[x]=a,m[x+1]=b,m[x+2]=c,m[x+3]=n,m[x+4]=h,m[x+5]=f,m[x+6]=l,m[x+7]=k,m[x+8]=r,x+=9);this.last4=x!==this.indx+9;this.indx=x};v.prototype.setNormal4=function(a,b,c,d,e,g,n,h,f,l,k,r,u){if(this.last4&&u)return console.error("missmatch between addFace4 and setNormal4 calls");var m=this.indx-(this.last4?18:9),w=this.norm;1!==u&&(w[m]=a,w[m+1]=b,w[m+2]=c,w[m+3]=d,w[m+4]=e,w[m+5]=g,w[m+6]=n,w[m+7]=h,w[m+8]=
f,m+=9);2!==u&&(w[m]=a,w[m+1]=b,w[m+2]=c,w[m+3]=n,w[m+4]=h,w[m+5]=f,w[m+6]=l,w[m+7]=k,w[m+8]=r)};v.prototype.recalcZ=function(a){for(var b=this.pos,c=this.indx,d=c-(this.last4?18:9);d<c;)b[d+2]=a(b[d],b[d+1],b[d+2]),d+=3};v.prototype.calcNormal=function(){this.cb||(this.pA=new f.Vector3,this.pB=new f.Vector3,this.pC=new f.Vector3,this.cb=new f.Vector3,this.ab=new f.Vector3);this.pA.fromArray(this.pos,this.indx-9);this.pB.fromArray(this.pos,this.indx-6);this.pC.fromArray(this.pos,this.indx-3);this.cb.subVectors(this.pC,
this.pB);this.ab.subVectors(this.pA,this.pB);this.cb.cross(this.ab);this.setNormal(this.cb.x,this.cb.y,this.cb.z)};v.prototype.setNormal=function(a,b,c){var d=this.indx-9,e=this.norm;e[d]=e[d+3]=e[d+6]=a;e[d+1]=e[d+4]=e[d+7]=b;e[d+2]=e[d+5]=e[d+8]=c;this.last4&&(d-=9,e[d]=e[d+3]=e[d+6]=a,e[d+1]=e[d+4]=e[d+7]=b,e[d+2]=e[d+5]=e[d+8]=c)};v.prototype.setNormal_12_34=function(a,b,c,d,e,g,n){void 0===n&&(n=0);var h=this.indx-(0<n?9:18),f=this.norm;1!==n&&(f[h]=a,f[h+1]=b,f[h+2]=c,f[h+3]=a,f[h+4]=b,f[h+
5]=c,f[h+6]=d,f[h+7]=e,f[h+8]=g,h+=9);2!==n&&(f[h]=a,f[h+1]=b,f[h+2]=c,f[h+3]=d,f[h+4]=e,f[h+5]=g,f[h+6]=d,f[h+7]=e,f[h+8]=g)};v.prototype.create=function(){this.nfaces!==this.indx/9&&console.error("Mismatch with created "+this.nfaces+" and filled "+this.indx/9+" number of faces");var a=new f.BufferGeometry;a.setAttribute("position",new f.BufferAttribute(this.pos,3));a.setAttribute("normal",new f.BufferAttribute(this.norm,3));return a};A.prototype.startPolygon=function(a){this.multi=1;this.mnormal=
a};A.prototype.stopPolygon=function(){this.multi&&(this.multi=0,console.error("Polygon should be already closed at this moment"))};A.prototype.addFace3=function(a,b,c,d,e,g,f,h,k){this.addFace4(a,b,c,d,e,g,f,h,k,f,h,k,2)};A.prototype.addFace4=function(a,b,c,d,e,g,f,h,k,l,m,r,u){void 0===u&&(u=0);this.v1=new y.Vertex(a,b,c,0,0,0);this.v2=1===u?null:new y.Vertex(d,e,g,0,0,0);this.v3=new y.Vertex(f,h,k,0,0,0);this.v4=2===u?null:new y.Vertex(l,m,r,0,0,0);this.reduce=u;if(this.multi)2!==u&&console.error("polygon not supported for not-reduced faces"),
1===this.multi++?(u=new y.Polygon,u.vertices.push(this.mnormal?this.v2:this.v3),this.polygons.push(u)):(u=this.polygons[this.polygons.length-1],1E-12<(this.mnormal?this.v2:this.v3).diff(this.mnormal?u.vertices[u.vertices.length-1]:u.vertices[0])&&console.error("vertex missmatch when building polygon")),1E-12>(this.mnormal?this.v3:this.v2).diff(this.mnormal?u.vertices[0]:u.vertices[u.vertices.length-1])?this.multi=0:this.mnormal?u.vertices.push(this.v3):u.vertices.unshift(this.v2);else{a=new y.Polygon;
switch(u){case 0:a.vertices.push(this.v1,this.v2,this.v3,this.v4);break;case 1:a.vertices.push(this.v1,this.v3,this.v4);break;case 2:a.vertices.push(this.v1,this.v2,this.v3)}this.polygons.push(a)}};A.prototype.setNormal4=function(a,b,c,d,e,g,f,h,k,l,m,r){this.v1.setnormal(a,b,c);this.v2&&this.v2.setnormal(d,e,g);this.v3.setnormal(f,h,k);this.v4&&this.v4.setnormal(l,m,r)};A.prototype.setNormal_12_34=function(a,b,c,d,e,g){this.v1.setnormal(a,b,c);this.v2&&this.v2.setnormal(a,b,c);this.v3.setnormal(d,
e,g);this.v4&&this.v4.setnormal(d,e,g)};A.prototype.calcNormal=function(){this.cb||(this.pA=new f.Vector3,this.pB=new f.Vector3,this.pC=new f.Vector3,this.cb=new f.Vector3,this.ab=new f.Vector3);this.pA.set(this.v1.x,this.v1.y,this.v1.z);1!==this.reduce?(this.pB.set(this.v2.x,this.v2.y,this.v2.z),this.pC.set(this.v3.x,this.v3.y,this.v3.z)):(this.pB.set(this.v3.x,this.v3.y,this.v3.z),this.pC.set(this.v4.x,this.v4.y,this.v4.z));this.cb.subVectors(this.pC,this.pB);this.ab.subVectors(this.pA,this.pB);
this.cb.cross(this.ab);this.setNormal(this.cb.x,this.cb.y,this.cb.z)};A.prototype.setNormal=function(a,b,c){this.v1.setnormal(a,b,c);this.v2&&this.v2.setnormal(a,b,c);this.v3.setnormal(a,b,c);this.v4&&this.v4.setnormal(a,b,c)};A.prototype.recalcZ=function(a){this.v1.z=a(this.v1.x,this.v1.y,this.v1.z);this.v2&&(this.v2.z=a(this.v2.x,this.v2.y,this.v2.z));this.v3.z=a(this.v3.x,this.v3.y,this.v3.z);this.v4&&(this.v4.z=a(this.v4.x,this.v4.y,this.v4.z))};A.prototype.create=function(){return{polygons:this.polygons}};
k.createMatrix=function(a){if(!a)return null;switch(a._typename){case "TGeoTranslation":var b=a.fTranslation;break;case "TGeoRotation":var c=a.fRotationMatrix;break;case "TGeoScale":var d=a.fScale;break;case "TGeoGenTrans":d=a.fScale;case "TGeoCombiTrans":b=a.fTranslation;a.fRotation&&(c=a.fRotation.fRotationMatrix);break;case "TGeoHMatrix":b=a.fTranslation;c=a.fRotationMatrix;d=a.fScale;break;case "TGeoIdentity":break;default:console.warn("unsupported matrix "+a._typename)}if(!b&&!c&&!d)return null;
a=new f.Matrix4;c&&a.set(c[0],c[1],c[2],0,c[3],c[4],c[5],0,c[6],c[7],c[8],0,0,0,0,1);b&&a.setPosition(b[0],b[1],b[2]);d&&a.scale(new f.Vector3(d[0],d[1],d[2]));return a};k.getNodeMatrix=function(a,b){var c=null;if(1===a)c=new f.Matrix4,b.fTrans&&(c.set(b.fTrans[0],b.fTrans[4],b.fTrans[8],0,b.fTrans[1],b.fTrans[5],b.fTrans[9],0,b.fTrans[2],b.fTrans[6],b.fTrans[10],0,0,0,0,1),c.setPosition(b.fTrans[12],b.fTrans[13],b.fTrans[14]));else if(b.fMatrix)c=k.createMatrix(b.fMatrix);else if("TGeoNodeOffset"==
b._typename&&b.fFinder)switch(a=JSROOT.BIT(14),0!==(b.fFinder.fBits&a)&&k.warn("Unsupported reflected pattern "+b.fFinder._typename),b.fFinder._typename){case "TGeoPatternX":case "TGeoPatternY":case "TGeoPatternZ":case "TGeoPatternParaX":case "TGeoPatternParaY":case "TGeoPatternParaZ":a=b.fFinder.fStart+(b.fIndex+.5)*b.fFinder.fStep;c=new f.Matrix4;switch(b.fFinder._typename[b.fFinder._typename.length-1]){case "X":c.setPosition(a,0,0);break;case "Y":c.setPosition(0,a,0);break;case "Z":c.setPosition(0,
0,a)}break;case "TGeoPatternCylPhi":c=Math.PI/180*(b.fFinder.fStart+(b.fIndex+.5)*b.fFinder.fStep);b=Math.cos(c);a=Math.sin(c);c=new f.Matrix4;c.set(b,-a,0,0,a,b,0,0,0,0,1,0,0,0,0,1);break;case "TGeoPatternCylR":c=new f.Matrix4;break;case "TGeoPatternTrapZ":a=b.fFinder.fStart+(b.fIndex+.5)*b.fFinder.fStep;c=new f.Matrix4;c.setPosition(b.fFinder.fTxz*a,b.fFinder.fTyz*a,a);break;default:k.warn("Unsupported pattern type "+b.fFinder._typename)}return c};k.numGeometryFaces=function(a){return a?a instanceof
y.Geometry?a.tree.numPolygons():"BufferGeometry"==a.type?(a=a.getAttribute("position"))&&a.count?Math.round(a.count/3):0:a.polygons?a.polygons.length:a.faces.length:0};k.numGeometryVertices=function(a){return a?a instanceof y.Geometry?3*a.tree.numPolygons():"BufferGeometry"==a.type?(a=a.getAttribute("position"))?a.count:0:a.polygons?4*a.polygons.length:a.vertices.length:0};var Ia=function(a,b){void 0===b&&(b=0);try{switch(a._typename){case "TGeoBBox":if(0>b)var c=12;else{var d=a.fDX,e=a.fDY,g=a.fDZ,
n=b?new A:new v(12);n.addFace4(d,e,g,d,-e,g,d,-e,-g,d,e,-g);n.setNormal(1,0,0);n.addFace4(-d,e,-g,-d,-e,-g,-d,-e,g,-d,e,g);n.setNormal(-1,0,0);n.addFace4(-d,e,-g,-d,e,g,d,e,g,d,e,-g);n.setNormal(0,1,0);n.addFace4(-d,-e,g,-d,-e,-g,d,-e,-g,d,-e,g);n.setNormal(0,-1,0);n.addFace4(-d,e,g,-d,-e,g,d,-e,g,d,e,g);n.setNormal(0,0,1);n.addFace4(d,e,-g,d,-e,-g,-d,-e,-g,-d,e,-g);n.setNormal(0,0,-1);c=n.create()}return c;case "TGeoPara":if(0>b)var h=12;else{var t=a.fTxy,l=a.fTxz,m=a.fTyz;h=nb([-a.fZ*l-t*a.fY-a.fX,
-a.fY-a.fZ*m,-a.fZ,-a.fZ*l+t*a.fY-a.fX,a.fY-a.fZ*m,-a.fZ,-a.fZ*l+t*a.fY+a.fX,a.fY-a.fZ*m,-a.fZ,-a.fZ*l-t*a.fY+a.fX,-a.fY-a.fZ*m,-a.fZ,a.fZ*l-t*a.fY-a.fX,-a.fY+a.fZ*m,a.fZ,a.fZ*l+t*a.fY-a.fX,a.fY+a.fZ*m,a.fZ,a.fZ*l+t*a.fY+a.fX,a.fY+a.fZ*m,a.fZ,a.fZ*l-t*a.fY+a.fX,-a.fY+a.fZ*m,a.fZ],b)}return h;case "TGeoTrd1":case "TGeoTrd2":if(0>b)var r=12;else{var u;if("TGeoTrd1"==a._typename)var x=u=a.fDY;else x=a.fDy1,u=a.fDy2;r=nb([-a.fDx1,x,-a.fDZ,a.fDx1,x,-a.fDZ,a.fDx1,-x,-a.fDZ,-a.fDx1,-x,-a.fDZ,-a.fDx2,u,a.fDZ,
a.fDx2,u,a.fDZ,a.fDx2,-u,a.fDZ,-a.fDx2,-u,a.fDZ],b)}return r;case "TGeoArb8":case "TGeoTrap":case "TGeoGtra":var w=b;if(0>w)var oa=12;else{for(var q=[a.fXY[0][0],a.fXY[0][1],-a.fDZ,a.fXY[1][0],a.fXY[1][1],-a.fDZ,a.fXY[2][0],a.fXY[2][1],-a.fDZ,a.fXY[3][0],a.fXY[3][1],-a.fDZ,a.fXY[4][0],a.fXY[4][1],a.fDZ,a.fXY[5][0],a.fXY[5][1],a.fDZ,a.fXY[6][0],a.fXY[6][1],a.fDZ,a.fXY[7][0],a.fXY[7][1],a.fDZ],p=[4,7,6,6,5,4,3,7,4,4,0,3,5,1,0,0,4,5,6,2,1,1,5,6,7,3,2,2,6,7,1,2,3,3,0,1],y=0;y<q.length;y+=q.length/2)for(var Sa=
y;Sa<y+q.length/2-3;Sa+=3)for(var ob=Sa+3;ob<y+q.length/2;ob+=3)if(q[Sa]===q[ob]&&q[Sa+1]===q[ob+1]&&q[Sa+2]===q[ob+2])for(var Y=0;Y<p.length;++Y)p[Y]===ob/3&&(p[Y]=Sa/3);for(var Ac=[],Tb=0,C=0;C<p.length;C+=3){var Ub=100*p[C]+10*p[C+1]+p[C+2],Vb=100*p[C+1]+10*p[C+2]+p[C],Wb=100*p[C+2]+10*p[C]+p[C+1];p[C]==p[C+1]||p[C]==p[C+2]||p[C+1]==p[C+2]||0<=Ac.indexOf(Ub)||0<=Ac.indexOf(Vb)||0<=Ac.indexOf(Wb)?p[C]=p[C+1]=p[C+2]=-1:(Ac.push(Ub,Vb,Wb),Tb++)}for(var Ta=w?new A:new v(Tb),pa=0;pa<p.length;pa+=6){var ia=
3*p[pa],va=3*p[pa+1],wa=3*p[pa+2],Ja=3*p[pa+3],xa=3*p[pa+4],pb=3*p[pa+5],Ua=null;if(0<=ia&&0<=Ja&&w)if(0===pa)Ua=new f.Vector3(0,0,1);else if(30===pa)Ua=new f.Vector3(0,0,-1);else{var wd=k.produceNormal(q[ia],q[ia+1],q[ia+2],q[va],q[va+1],q[va+2],q[wa],q[wa+1],q[wa+2]);wd.normalize();var Xb=k.produceNormal(q[Ja],q[Ja+1],q[Ja+2],q[xa],q[xa+1],q[xa+2],q[pb],q[pb+1],q[pb+2]);Xb.normalize();1E-12>wd.distanceToSquared(Xb)&&(Ua=wd)}null!==Ua?(Ta.addFace4(q[ia],q[ia+1],q[ia+2],q[va],q[va+1],q[va+2],q[wa],
q[wa+1],q[wa+2],q[xa],q[xa+1],q[xa+2]),Ta.setNormal(Ua.x,Ua.y,Ua.z)):(0<=ia&&(Ta.addFace3(q[ia],q[ia+1],q[ia+2],q[va],q[va+1],q[va+2],q[wa],q[wa+1],q[wa+2]),Ta.calcNormal()),0<=Ja&&(Ta.addFace3(q[Ja],q[Ja+1],q[Ja+2],q[xa],q[xa+1],q[xa+2],q[pb],q[pb+1],q[pb+2]),Ta.calcNormal()))}oa=Ta.create()}return oa;case "TGeoSphere":var Bc=b,B=[a.fRmax,a.fRmin],Ie=a.fPhi1,xd=a.fPhi2-a.fPhi1,Je=a.fTheta1,Ke=a.fTheta2-a.fTheta1,G=a.fNseg,I=a.fNz,Ka=0>=B[1];if(0<Bc){var yd=(Ka?2:4)*G*I/Bc;1<yd&&(G=Math.max(4,Math.floor(G/
Math.sqrt(yd))),I=Math.max(4,Math.floor(I/Math.sqrt(yd))))}var Cc=G*I*2,Dc=2*G,Ec=2*G,Ud=360===xd?0:I*(Ka?2:4);Ka&&(Ec=Dc=G);if(0>Bc)var Vd=Cc*(Ka?1:2)+Dc+Ec+Ud;else{for(var J=new Float32Array(G+1),K=new Float32Array(G+1),z=new Float32Array(I+1),L=new Float32Array(I+1),Yb=0;Yb<=I;++Yb){var Wd=(Je+Ke/I*Yb)*Math.PI/180;z[Yb]=Math.sin(Wd);L[Yb]=Math.cos(Wd)}for(var Zb=0;Zb<=G;++Zb){var Xd=(Ie+xd/G*Zb)*Math.PI/180;J[Zb]=Math.sin(Xd);K[Zb]=Math.cos(Xd)}1E-10>=Math.abs(z[0])&&(Cc-=G,Dc=0);1E-10>=Math.abs(z[I])&&
(Cc-=G,Ec=0);for(var Le=Cc*(Ka?1:2)+Dc+Ec+Ud,Va=Bc?new A:new v(Le),qb=0;2>qb&&(1!==qb||!Ka);++qb)for(var Z=B[qb],aa=0===qb?1:-1,Yd=1-qb,Me=1-Yd,Fc=0;Fc<I;++Fc){var W=Fc+Yd,X=Fc+Me,Gc=0;1E-10>=Math.abs(z[W])?Gc=1:1E-10>=Math.abs(z[X])&&(Gc=2);for(var E=0;E<G;++E)Va.addFace4(Z*z[W]*K[E],Z*z[W]*J[E],Z*L[W],Z*z[W]*K[E+1],Z*z[W]*J[E+1],Z*L[W],Z*z[X]*K[E+1],Z*z[X]*J[E+1],Z*L[X],Z*z[X]*K[E],Z*z[X]*J[E],Z*L[X],Gc),Va.setNormal4(aa*z[W]*K[E],aa*z[W]*J[E],aa*L[W],aa*z[W]*K[E+1],aa*z[W]*J[E+1],aa*L[W],aa*z[X]*
K[E+1],aa*z[X]*J[E+1],aa*L[X],aa*z[X]*K[E],aa*z[X]*J[E],aa*L[X],Gc)}for(var rb=0;rb<=I;rb+=I)if(1E-10<=Math.abs(z[rb]))for(var La=z[rb],Hc=L[rb],$b=0===rb?0:1,Ic=1-$b,qa=0;qa<G;++qa)Va.addFace4(B[1]*La*K[qa+$b],B[1]*La*J[qa+$b],B[1]*Hc,B[0]*La*K[qa+$b],B[0]*La*J[qa+$b],B[0]*Hc,B[0]*La*K[qa+Ic],B[0]*La*J[qa+Ic],B[0]*Hc,B[1]*La*K[qa+Ic],B[1]*La*J[qa+Ic],B[1]*Hc,Ka?2:0),Va.calcNormal();if(360>xd)for(var ac=0;ac<=G;ac+=G)for(var Jc=J[ac],Kc=K[ac],Wa=0===ac?1:0,sb=1-Wa,M=0;M<I;++M)Va.addFace4(B[1]*z[M+
Wa]*Kc,B[1]*z[M+Wa]*Jc,B[1]*L[M+Wa],B[0]*z[M+Wa]*Kc,B[0]*z[M+Wa]*Jc,B[0]*L[M+Wa],B[0]*z[M+sb]*Kc,B[0]*z[M+sb]*Jc,B[0]*L[M+sb],B[1]*z[M+sb]*Kc,B[1]*z[M+sb]*Jc,B[1]*L[M+sb],Ka?2:0),Va.calcNormal();Vd=Va.create()}return Vd;case "TGeoCone":case "TGeoConeSeg":case "TGeoTube":case "TGeoTubeSeg":case "TGeoCtub":return Td(a,b);case "TGeoEltu":var Zd=b,Ma=Math.max(4,Math.round(360/k.GradPerSegm));if(0>Zd)var $d=4*Ma;else{for(var Na=new Float32Array(Ma+1),Oa=new Float32Array(Ma+1),bc=0;bc<=Ma;++bc){var ae=
bc/Ma*2*Math.PI;Na[bc]=a.fRmin*Math.cos(ae);Oa[bc]=a.fRmax*Math.sin(ae)}for(var cc=Zd?new A:new v(4*Ma),be,ce,tb=1,ub=0,ba=0;ba<Ma;++ba){cc.addFace4(Na[ba],Oa[ba],+a.fDZ,Na[ba],Oa[ba],-a.fDZ,Na[ba+1],Oa[ba+1],-a.fDZ,Na[ba+1],Oa[ba+1],a.fDZ);be=tb;ce=ub;tb=Na[ba+1]*a.fRmax/a.fRmin;ub=Oa[ba+1]*a.fRmin/a.fRmax;var de=Math.sqrt(tb*tb+ub*ub);tb/=de;ub/=de;cc.setNormal_12_34(be,ce,0,tb,ub,0)}for(var dc=0;2>dc;++dc)for(var Lc=0===dc?1:-1,ee=dc,fe=1-dc,vb=0;vb<Ma;++vb)cc.addFace3(0,0,Lc*a.fDZ,Na[vb+ee],Oa[vb+
ee],Lc*a.fDZ,Na[vb+fe],Oa[vb+fe],Lc*a.fDZ),cc.setNormal(0,0,Lc);$d=cc.create()}return $d;case "TGeoTorus":var wb=b,D=a.fR,ja=Math.max(6,Math.round(360/k.GradPerSegm)),ka=Math.max(8,Math.round(a.fDphi/k.GradPerSegm)),xb=(0<a.fRmin?4:2)*ja*(ka+(360!==a.fDphi?1:0));if(0>wb)var ge=xb;else{0<wb&&xb>wb&&(ja=Math.floor(ja/Math.sqrt(xb/wb)),ka=Math.floor(ka/Math.sqrt(xb/wb)),xb=(0<a.fRmin?4:2)*ja*(ka+(360!==a.fDphi?1:0)));for(var ya=new Float32Array(ja+1),H=new Float32Array(ja+1),ca=new Float32Array(ka+1),
da=new Float32Array(ka+1),yb=0;yb<=ja;++yb)ya[yb]=Math.sin(yb/ja*2*Math.PI),H[yb]=Math.cos(yb/ja*2*Math.PI);for(var ec=0;ec<=ka;++ec){var he=(a.fPhi1+a.fDphi*ec/ka)/180*Math.PI;ca[ec]=Math.sin(he);da[ec]=Math.cos(he)}for(var fc=wb?new A:new v(xb),Xa=new f.Vector3,Ya=new f.Vector3,Za=new f.Vector3,$a=new f.Vector3,Mc=new f.Vector3,Nc=new f.Vector3,Oc=new f.Vector3,Pc=new f.Vector3,Qc=new f.Vector3,Rc=new f.Vector3,zb=0;2>zb&&!(0<zb&&0>=a.fRmin);++zb)for(var ea=0<zb?a.fRmin:a.fRmax,ie=1-zb,Ne=1-ie,
fa=0<zb?-1:1,Sc=0;Sc<ka;++Sc){var Ab=Sc+ie,Bb=Sc+Ne;Qc.x=D*da[Ab];Qc.y=D*ca[Ab];Rc.x=D*da[Bb];Rc.y=D*ca[Bb];for(var N=0;N<ja;++N)Xa.x=(D+ea*H[N])*da[Ab],Xa.y=(D+ea*H[N])*ca[Ab],Xa.z=ea*ya[N],Ya.x=(D+ea*H[N+1])*da[Ab],Ya.y=(D+ea*H[N+1])*ca[Ab],Ya.z=ea*ya[N+1],Za.x=(D+ea*H[N+1])*da[Bb],Za.y=(D+ea*H[N+1])*ca[Bb],Za.z=ea*ya[N+1],$a.x=(D+ea*H[N])*da[Bb],$a.y=(D+ea*H[N])*ca[Bb],$a.z=ea*ya[N],fc.addFace4(Xa.x,Xa.y,Xa.z,Ya.x,Ya.y,Ya.z,Za.x,Za.y,Za.z,$a.x,$a.y,$a.z),Mc.subVectors(Xa,Qc).normalize(),Nc.subVectors(Ya,
Qc).normalize(),Oc.subVectors(Za,Rc).normalize(),Pc.subVectors($a,Rc).normalize(),fc.setNormal4(fa*Mc.x,fa*Mc.y,fa*Mc.z,fa*Nc.x,fa*Nc.y,fa*Nc.z,fa*Oc.x,fa*Oc.y,fa*Oc.z,fa*Pc.x,fa*Pc.y,fa*Pc.z)}if(360!==a.fDphi)for(var O=0;O<=ka;O+=ka)for(var Cb=a.fRmax,Db=a.fRmin,ab=0<O?0:1,Eb=1-ab,Oe=0<a.fRmin?0:1,je=0<O?1:-1,P=0;P<ja;++P)fc.addFace4((D+Cb*H[P+ab])*da[O],(D+Cb*H[P+ab])*ca[O],Cb*ya[P+ab],(D+Db*H[P+ab])*da[O],(D+Db*H[P+ab])*ca[O],Db*ya[P+ab],(D+Db*H[P+Eb])*da[O],(D+Db*H[P+Eb])*ca[O],Db*ya[P+Eb],(D+
Cb*H[P+Eb])*da[O],(D+Cb*H[P+Eb])*ca[O],Cb*ya[P+Eb],Oe),fc.setNormal(-je*ca[O],je*da[O],0);ge=fc.create()}return ge;case "TGeoPcon":case "TGeoPgon":var ke=b,Pe=a.fPhi1,Tc=a.fDphi;if("TGeoPgon"==a._typename){var Q=a.fNedges;var bb=1/Math.cos(Math.PI/180*Tc/Q/2)}else Q=Math.max(5,Math.round(Tc/k.GradPerSegm)),bb=1;for(var zd=new Int16Array(2*a.fNz),le=0,cb=!1,Ad=0;Ad<a.fNz;++Ad)0<a.fRmin[Ad]&&(cb=!0);if(0>ke)var me=(cb?4:2)*Q*(a.fNz-1);else{for(var za=360===Tc?null:[],db=0;2>db;++db)for(var Uc=0===db?
"fRmax":"fRmin",R=0;R<a.fNz;++R){var Bd=a.fZ[R],Fb=a[Uc][R];zd[2*R+db]=0;0<R&&R<a.fNz-1&&(a.fZ[R-1]===Bd&&a[Uc][R-1]===Fb||a[Uc][R+1]===Fb&&a[Uc][R-1]===Fb)||(0<R&&(0===db||cb)&&(zd[2*R+db]=1,le++),null!==za&&(0===db?za.push(new f.Vector2(bb*Fb,Bd)):Fb<a.fRmax[R]&&za.unshift(new f.Vector2(bb*Fb,Bd))))}var Vc=le*Q*2;a.fRmin[0]!==a.fRmax[0]&&(Vc+=Q*(cb?2:1));a.fRmin[a.fNz-1]!==a.fRmax[a.fNz-1]&&(Vc+=Q*(cb?2:1));var la=null;if(null!==za){if(za.length===2*a.fNz){la=[];for(var Pa=a.fNz-1;0<Pa;--Pa)if(a.fZ[Pa]!==
a.fZ[Pa-1]){var Cd=2*a.fNz-1-Pa;la.push([Cd,Pa-1,Pa]);la.push([Cd,Cd+1,Pa-1])}}else la=f.ShapeUtils.triangulateShape(za,[]);Vc+=2*la.length}for(var ne=Pe*Math.PI/180,oe=Tc/Q*Math.PI/180,S=new Float32Array(Q+1),T=new Float32Array(Q+1),Gb=0;Gb<=Q;++Gb)T[Gb]=Math.cos(ne+Gb*oe),S[Gb]=Math.sin(ne+Gb*oe);for(var Aa=ke?new A:new v(Vc),eb=0;2>eb;++eb)for(var pe=0===eb?"fRmax":"fRmin",Wc=a.fZ[0],fb=bb*a[pe][0],Hb=1-eb,Ib=eb,gc=0;gc<a.fNz;++gc)if(0!==zd[2*gc+eb]){var Xc=a.fZ[gc],gb=bb*a[pe][gc],Jb=1,Yc=0;if(gb!==
fb){var qe=Math.atan2(gb-fb,Xc-Wc);Jb=Math.cos(qe);Yc=Math.sin(qe)}0<eb&&(Jb*=-1,Yc*=-1);for(var U=0;U<Q;++U)Aa.addFace4(fb*T[U+Hb],fb*S[U+Hb],Wc,gb*T[U+Hb],gb*S[U+Hb],Xc,gb*T[U+Ib],gb*S[U+Ib],Xc,fb*T[U+Ib],fb*S[U+Ib],Wc),Aa.setNormal_12_34(Jb*T[U+Hb],Jb*S[U+Hb],Yc,Jb*T[U+Ib],Jb*S[U+Ib],Yc);Wc=Xc;fb=gb}for(var Qa=0;Qa<a.fNz;Qa+=a.fNz-1){var hc=bb*a.fRmin[Qa],ic=bb*a.fRmax[Qa];if(hc!==ic){var Zc=a.fZ[Qa],jc=0===Qa?1:0,$c=1-jc,Qe=0===Qa?-1:1;cb||la||Aa.startPolygon(0<Qa);for(var ra=0;ra<Q;++ra)Aa.addFace4(hc*
T[ra+jc],hc*S[ra+jc],Zc,ic*T[ra+jc],ic*S[ra+jc],Zc,ic*T[ra+$c],ic*S[ra+$c],Zc,hc*T[ra+$c],hc*S[ra+$c],Zc,cb?0:2),Aa.setNormal(0,0,Qe);Aa.stopPolygon()}}if(la)for(var Ba=0;Ba<=Q;Ba+=Q)for(var re=0===Ba?1:2,Re=3-re,kc=0;kc<la.length;++kc){var Dd=za[la[kc][0]],Ed=za[la[kc][re]],Fd=za[la[kc][Re]];Aa.addFace3(Dd.x*T[Ba],Dd.x*S[Ba],Dd.y,Ed.x*T[Ba],Ed.x*S[Ba],Ed.y,Fd.x*T[Ba],Fd.x*S[Ba],Fd.y);Aa.calcNormal()}me=Aa.create()}return me;case "TGeoXtru":var se=b,Gd=(a.fNz-1)*a.fNvert*2;if(0>se)var te=Gd+3*a.fNvert;
else{for(var hb=[],ad=0;ad<a.fNvert;++ad)hb.push(new f.Vector2(a.fX[ad],a.fY[ad]));var lc=f.ShapeUtils.triangulateShape(hb,[]);lc.length<hb.length-2?(k.warn("Problem with XTRU shape "+a.fName+" with "+hb.length+" vertices"),lc=[]):Gd+=2*lc.length;for(var mc=se?new A:new v(Gd),sa=0;sa<a.fNz-1;++sa)for(var ue=a.fZ[sa],bd=a.fScale[sa],ve=a.fZ[sa+1],cd=a.fScale[sa+1],we=a.fX0[sa],xe=a.fX0[sa+1],ye=a.fY0[sa],ze=a.fY0[sa+1],ib=0;ib<a.fNvert;++ib){var dd=(ib+1)%a.fNvert;mc.addFace4(bd*a.fX[ib]+we,bd*a.fY[ib]+
ye,ue,cd*a.fX[ib]+xe,cd*a.fY[ib]+ze,ve,cd*a.fX[dd]+xe,cd*a.fY[dd]+ze,ve,bd*a.fX[dd]+we,bd*a.fY[dd]+ye,ue);mc.calcNormal()}for(var Ca=0;Ca<=a.fNz-1;Ca+=a.fNz-1)for(var Hd=a.fZ[Ca],Kb=a.fScale[Ca],Id=a.fX0[Ca],Jd=a.fY0[Ca],Kd=0;Kd<lc.length;++Kd){var Ld=lc[Kd],Ae=hb[Ld[0]],Be=hb[Ld[0===Ca?2:1]],Ce=hb[Ld[0===Ca?1:2]];mc.addFace3(Kb*Ae.x+Id,Kb*Ae.y+Jd,Hd,Kb*Be.x+Id,Kb*Be.y+Jd,Hd,Kb*Ce.x+Id,Kb*Ce.y+Jd,Hd);mc.setNormal(0,0,0===Ca?-1:1)}te=mc.create()}return te;case "TGeoParaboloid":var ed=b,ha=Math.max(4,
Math.round(360/k.GradPerSegm)),ma=30;if(0<ed){var Md=2*ha*(ma+1)/ed;1<Md&&(ha=Math.max(5,Math.floor(ha/Math.sqrt(Md))),ma=Math.max(5,Math.floor(ma/Math.sqrt(Md))))}var nc=-a.fDZ,oc=a.fDZ,pc=a.fRlo,fd=a.fRhi;0<=a.fA?a.fB>nc&&(nc=a.fB):a.fB<oc&&(oc=a.fB);var De=Math.atan2(nc,pc),Se=Math.atan2(oc,fd),gd=(ma+1)*ha*2;0===pc&&(gd-=2*ha);0===fd&&(gd-=2*ha);if(0>ed)var Ee=gd;else{for(var Da=new Float32Array(ha+1),Ea=new Float32Array(ha+1),Lb=0;Lb<=ha;++Lb)Ea[Lb]=Math.cos(Lb/ha*2*Math.PI),Da[Lb]=Math.sin(Lb/
ha*2*Math.PI);for(var hd=ed?new A:new v(gd),Nd=nc,jb=0,qc=0,Od=-1,Fa=0;Fa<=ma+1;++Fa){var kb=0,V=0,Mb=0,id=-1;if(0!==Fa||0!==pc){if(Fa===ma+1&&0===jb)break;switch(Fa){case 0:kb=nc;V=pc;break;case ma:kb=oc;V=fd;break;case ma+1:kb=oc;V=0;break;default:var jd=Math.tan(De+(Se-De)*Fa/ma);V=.5*(jd+Math.sqrt(jd*jd-4*a.fA*a.fB))/a.fA;1E-6>V&&(V=0);kb=V*jd}Mb=a.fA*V;id=0<a.fA?-1:1;var rc=0;0===jb?rc=1:0===V&&(rc=2);for(var F=0;F<ha;++F)hd.addFace4(V*Ea[F],V*Da[F],kb,jb*Ea[F],jb*Da[F],Nd,jb*Ea[F+1],jb*Da[F+
1],Nd,V*Ea[F+1],V*Da[F+1],kb,rc),0===rc||1===Fa&&0===pc||Fa===ma+1&&0===fd?hd.setNormal4(Mb*Ea[F],Mb*Da[F],id,qc*Ea[F],qc*Da[F],Od,qc*Ea[F+1],qc*Da[F+1],Od,Mb*Ea[F+1],Mb*Da[F+1],id,rc):hd.setNormal(0,0,Fa<ma?-1:1);Nd=kb;jb=V;qc=Mb;Od=id}}Ee=hd.create()}return Ee;case "TGeoHype":var lb=b;if(0===a.fTin&&0===a.fTout)var Pd=Td(a,lb);else{var na=Math.max(4,Math.round(360/k.GradPerSegm)),mb=30,Nb=na*(mb+1)*(0<a.fRmin?4:2);if(0>lb)Pd=Nb;else{0<lb&&lb>Nb&&(na=Math.max(4,Math.floor(na/Math.sqrt(Nb/lb))),mb=
Math.max(4,Math.floor(mb/Math.sqrt(Nb/lb))),Nb=na*(mb+1)*(0<a.fRmin?4:2));for(var Ga=new Float32Array(na+1),Ha=new Float32Array(na+1),Ob=0;Ob<=na;++Ob)Ha[Ob]=Math.cos(Ob/na*2*Math.PI),Ga[Ob]=Math.sin(Ob/na*2*Math.PI);for(var sc=lb?new A:new v(Nb),Pb=0;2>Pb&&!(0<Pb&&0>=a.fRmin);++Pb)for(var kd=0<Pb?a.fRmin:a.fRmax,Fe=0<Pb?a.fTinsq:a.fToutsq,tc=1-Pb,ld=1-tc,md=0;md<mb;++md)for(var nd=-a.fDz+md/mb*2*a.fDz,od=-a.fDz+(md+1)/mb*2*a.fDz,pd=Math.sqrt(kd*kd+Fe*nd*nd),qd=Math.sqrt(kd*kd+Fe*od*od),ta=0;ta<na;++ta)sc.addFace4(pd*
Ha[ta+tc],pd*Ga[ta+tc],nd,qd*Ha[ta+tc],qd*Ga[ta+tc],od,qd*Ha[ta+ld],qd*Ga[ta+ld],od,pd*Ha[ta+ld],pd*Ga[ta+ld],nd),sc.calcNormal();for(var uc=0;2>uc;++uc)for(var Ra=0===uc?a.fDz:-a.fDz,rd=Math.sqrt(a.fRmax*a.fRmax+a.fToutsq*Ra*Ra),sd=0<a.fRmin?Math.sqrt(a.fRmin*a.fRmin+a.fTinsq*Ra*Ra):0,Te=0<a.fRmin?0:1,vc=1-uc,td=1-vc,ua=0;ua<na;++ua)sc.addFace4(rd*Ha[ua+vc],rd*Ga[ua+vc],Ra,sd*Ha[ua+vc],sd*Ga[ua+vc],Ra,sd*Ha[ua+td],sd*Ga[ua+td],Ra,rd*Ha[ua+td],rd*Ga[ua+td],Ra,Te),sc.setNormal(0,0,0===uc?1:-1);Pd=
sc.create()}}return Pd;case "TGeoTessellated":for(var wc=0,Qd=0;Qd<a.fFacets.length;++Qd)wc=4==a.fFacets[Qd].fNvert?wc+2:wc+1;if(0>b)var Ge=wc;else{for(var ud=b?new A:new v(wc),Rd=0;Rd<a.fFacets.length;++Rd){var xc=a.fFacets[Rd],Qb=a.fVertices[xc.fIvert[0]].fVec,Rb=a.fVertices[xc.fIvert[1]].fVec,Sb=a.fVertices[xc.fIvert[2]].fVec;if(4==xc.fNvert){var Sd=a.fVertices[xc.fIvert[3]].fVec;ud.addFace4(Qb[0],Qb[1],Qb[2],Rb[0],Rb[1],Rb[2],Sb[0],Sb[1],Sb[2],Sd[0],Sd[1],Sd[2])}else ud.addFace3(Qb[0],Qb[1],Qb[2],
Rb[0],Rb[1],Rb[2],Sb[0],Sb[1],Sb[2]);ud.calcNormal()}Ge=ud.create()}return Ge;case "TGeoCompositeShape":return He(a,b);case "TGeoShapeAssembly":break;case "TGeoScaledShape":var vd=Ia(a.fShape,b);a.fScale&&0<=b&&"object"===typeof vd&&"function"===typeof vd.scale&&vd.scale(a.fScale.fScale[0],a.fScale.fScale[1],a.fScale.fScale[2]);return vd;case "TGeoHalfSpace":if(0>b)return 1;default:k.warn("unsupported shape type "+a._typename)}}catch(yc){var zc="";void 0!==yc.stack&&(zc=yc.stack.split("\n")[0],zc=
0<=zc.indexOf(yc.message)?yc.stack.split("\n")[1]:" at: "+zc);k.warn(a._typename+" err: "+yc.message+zc)}return 0>b?0:null};k.compareStacks=function(a,b){if(!a||!b)return 0;if(a===b)return a.length;for(var c=Math.min(a.length,b.length),d=0;d<c;++d)if(a[d]!==b[d])return d;return c};k.isSameStack=function(a,b){if(!a||!b)return!1;if(a===b)return!0;if(a.length!==b.length)return!1;for(var c=0;c<a.length;++c)if(a[c]!==b[c])return!1;return!0};t.prototype.setVisLevel=function(a){this.vislevel=a&&Number.isInteger(a)?
a:4};t.prototype.getVisLevel=function(){return this.vislevel};t.prototype.setMaxVisNodes=function(a){this.maxnodes=Number.isFinite(a)?a:1E4};t.prototype.getMaxVisNodes=function(){return this.maxnodes};t.prototype.updateNode=function(a){a&&Number.isInteger(a.id)&&a.id<this.nodes.length&&(this.nodes[a.id]=a)};t.prototype.getNodeShape=function(a){if(!this.origin||!this.nodes)return null;var b=this.origin[a];a=this.nodes[a];if(!b||!a)return null;if(0===a.kind){if(b.fVolume)return b.fVolume.fShape}else return b.fShape;
return null};t.prototype.cleanup=function(a,b){if(a)for(var c=0;c<a.length;++c)delete a[c].stack,a[c]=void 0;if(b)for(a=0;a<b.length;++a)delete b[a].geom,b[a]=void 0;if(this.nodes)for(b=0;b<this.nodes.length;++b)this.nodes[b]&&delete this.nodes[b].chlds;delete this.nodes;delete this.origin;delete this.sortmap};t.prototype.createClones=function(a,b,c){if(!b){if(a&&"$$Shape$$"==a._typename)return this.createClonesForShape(a);this.origin=[];b=1;c=k.getNodeKind(a)}if(!(0>c||!a||"_refid"in a)){a._refid=
this.origin.length;this.origin.push(a);b>this.maxdepth&&(this.maxdepth=b);var d=null;d=0===c?a.fVolume&&a.fVolume.fNodes?a.fVolume.fNodes.arr:null:a.fElements?a.fElements.arr:null;if(null!==d)for(k.checkDuplicates(a,d),a=0;a<d.length;++a)this.createClones(d[a],b+1,c);if(!(1<b)){this.nodes=[];b=[];for(d=0;d<this.origin.length;++d)a={id:d,kind:c,vol:0,nfaces:0},this.nodes.push(a),b.push(a);for(d=0;d<this.origin.length;++d){var e=this.origin[d];a=this.nodes[d];var g=null,f=null;1===c?(f=e.fShape,e.fElements&&
(g=e.fElements.arr)):e.fVolume&&(f=e.fVolume.fShape,e.fVolume.fNodes&&(g=e.fVolume.fNodes.arr));if(e=k.getNodeMatrix(c,e)){a.matrix=e.elements;if(1===a.matrix[0]){e=!0;for(var h=1;h<a.matrix.length&&e;++h)e=a.matrix[h]===(5===h||10===h||15===h?1:0);e&&delete a.matrix}a.matrix&&1==c&&(a.abs_matrix=!0)}f&&(a.fDX=f.fDX,a.fDY=f.fDY,a.fDZ=f.fDZ,a.vol=f.fDX*f.fDY*f.fDZ,void 0===f.$nfaces&&(f.$nfaces=Ia(f,-1)),a.nfaces=f.$nfaces,0>=a.nfaces&&(a.vol=0));if(g)for(a.chlds=Array(g.length),f=0;f<g.length;++f)a.chlds[f]=
g[f]._refid}for(c=0;c<this.origin.length;++c)delete this.origin[c]._refid;b.sort(function(a,b){return b.vol-a.vol});this.sortmap=Array(this.nodes.length);for(c=0;c<this.nodes.length;++c)this.sortmap[c]=b[c].id,b[c].sortid=c}}};t.prototype.createClonesForShape=function(a){this.origin=[];this.plain_shape=a;this.nodes=[{id:0,sortid:0,kind:2,name:"Shape",nfaces:a.nfaces,fDX:1,fDY:1,fDZ:1,vol:1,vis:!0}]};t.prototype.countVisibles=function(){var a=0;if(this.nodes)for(var b=0;b<this.nodes.length;++b)this.nodes[b].vis&&
a++;return a};t.prototype.markVisibles=function(a,b,c){if(this.plain_shape)return 1;if(!this.origin||!this.nodes)return 0;for(var d=0,e=0;e<this.nodes.length;++e){var g=this.nodes[e],f=this.origin[e];g.vis=0;delete g.nochlds;0===g.kind?f.fVolume&&(a?(g.vis=k.TestBit(f.fVolume,k.BITS.kVisOnScreen)?99:0,0==e&&g.vis&&c&&(g.vis=0),b&&(k.SetBit(f.fVolume,k.BITS.kVisNone,!1),k.SetBit(f.fVolume,k.BITS.kVisThis,0<g.vis),k.SetBit(f.fVolume,k.BITS.kVisDaughters,!0))):(g.vis=!k.TestBit(f.fVolume,k.BITS.kVisNone)&&
k.TestBit(f.fVolume,k.BITS.kVisThis)?99:0,k.TestBit(f,k.BITS.kVisDaughters)&&k.TestBit(f.fVolume,k.BITS.kVisDaughters)||(g.nochlds=!0),0<g.vis&&g.chlds&&!g.nochlds&&(g.vis=1),0==e&&(c&&(g.vis=0),delete g.nochlds))):(g.vis=f.fRnrSelf?99:0,0===e&&1===this.nodes.length&&(g.vis=99),this.vislevel=9999);if(0>=g.vol||0>=g.nfaces)g.vis=0;g.vis&&d++}return d};t.prototype.produceIdShifts=function(){function a(b,d){if(0>d.idshift&&(d.idshift=0,d.chlds))for(var c=0;c<d.chlds.length;++c)d.idshift+=a(b,b[d.chlds[c]]);
return d.idshift+1}for(var b=0;b<this.nodes.length;++b)this.nodes[b].idshift=-1;a(this.nodes,this.nodes[0])};t.prototype.getVisibleFlags=function(){for(var a=Array(this.nodes.length),b=0;b<this.nodes.length;++b)a[b]={vis:this.nodes[b].vis,nochlds:this.nodes[b].nochlds};return a};t.prototype.setVisibleFlags=function(a){if(!this.nodes||!a||!a.length!=this.nodes.length)return 0;for(var b=0,c=0;c<this.nodes.length;++c){var d=this.nodes[c];d.vis=a[c].vis;d.nochlds=a[c].nochlds;d.vis&&b++}return b};t.prototype.scanVisible=
function(a,b){if(!this.nodes)return 0;void 0===b&&(a||(a={}),b=a.vislvl||this.vislevel||4,88<b&&(b=88),a.stack=Array(100),a.nodeid=0,a.counter=0,a.last=0,a.CopyStack=function(a){var b={nodeid:this.nodeid,seqid:this.counter,stack:Array(this.last)};a&&(b.factor=a);for(a=0;a<this.last;++a)b.stack[a]=this.stack[a+1];return b},a.domatrix&&(a.matrices=[],a.mpool=[new f.Matrix4],a.getmatrix=function(){return this.matrices[this.last]}));var c=0,d=this.nodes[a.nodeid];if(a.domatrix){a.mpool[a.last+1]||(a.mpool[a.last+
1]=new f.Matrix4);var e=0<a.last?a.matrices[a.last-1]:new f.Matrix4;d.matrix?(a.matrices[a.last]=a.mpool[a.last].fromArray(e.elements),a.matrices[a.last].multiply(a.mpool[a.last+1].fromArray(d.matrix))):a.matrices[a.last]=e}d.nochlds&&(b=0);d.vis>b&&(!a.func||a.func(d))&&c++;a.counter++;if(0<b&&d.chlds){a.last++;for(e=0;e<d.chlds.length;++e)a.nodeid=d.chlds[e],a.stack[a.last]=e,c+=this.scanVisible(a,b-1);a.last--}else a.counter+=d.idshift||0;0===a.last&&(delete a.last,delete a.stack,delete a.CopyStack,
delete a.counter,delete a.matrices,delete a.mpool,delete a.getmatrix);return c};t.prototype.getNodeName=function(a){return this.origin?(a=this.origin[a])?k.getObjectName(a):"":(a=this.nodes[a])?a.name:""};t.prototype.resolveStack=function(a,b){var c={id:0,obj:null,node:this.nodes[0],name:this.name_prefix};b&&(c.matrix=new f.Matrix4,c.node.matrix&&c.matrix.fromArray(c.node.matrix));this.origin&&(c.obj=this.origin[0]);if(a)for(var d=0;d<a.length;++d){c.id=c.node.chlds[a[d]];c.node=this.nodes[c.id];
this.origin&&(c.obj=this.origin[c.id]);var e=this.getNodeName(c.id);e&&(c.name&&(c.name+="/"),c.name+=e);b&&c.node.matrix&&c.matrix.multiply((new f.Matrix4).fromArray(c.node.matrix))}return c};t.prototype.buildStackByIds=function(a){if(!a)return null;if(0!==a[0])return console.error("wrong ids - first should be 0"),null;for(var b=this.nodes[0],c=[],d=1;d<a.length;++d){var e=a[d];if(!b)return null;b=b.chlds.indexOf(e);if(0>b)return console.error("wrong nodes ids "+a[d]+" is not child of "+a[d-1]),
null;c.push(b);b=this.nodes[e]}return c};t.prototype.buildIdsByStack=function(a){if(!a)return null;for(var b=this.nodes[0],c=[0],d=0;d<a.length;++d)b=b.chlds[a[d]],c.push(b),b=this.nodes[b];return c};t.prototype.isIdInStack=function(a,b){if(!a)return!0;for(var c=this.nodes[0],d=0;d<b.length;++d){c=c.chlds[b[d]];if(c==a)return!0;c=this.nodes[c]}return!1};t.prototype.findStackByName=function(a){a=a.split("/");var b=0,c=[];if(this.getNodeName(b)!==a[0])return null;for(var d=1;d<a.length;++d){var e=this.nodes[b];
if(!e.chlds)return null;for(var g=0;g<e.chlds.length;++g){var f=e.chlds[g];if(this.getNodeName(f)===a[d]){c.push(g);b=f;break}}if(c.length===d-1)return null}return c};t.prototype.setDefaultColors=function(a){if((this.use_dflt_colors=a)&&!this.dflt_table){a=[];for(var b=0;110>b;b++)a.push(920);a[3]=390;a[4]=a[5]=406;a[6]=a[7]=593;a[8]=a[9]=613;a[10]=a[11]=622;a[12]=921;a[13]=590;a[14]=807;a[16]=401;a[20]=390;a[24]=a[25]=a[26]=592;a[29]=809;a[79]=798;this.dflt_table=a}};t.prototype.getDrawEntryProperties=
function(a){var b=this.nodes[a.nodeid];if(2===b.kind){b={name:b.name,nname:b.name,shape:null,material:null,chlds:null};var c=a.opacity||1;b.fillcolor=new f.Color(a.color?"rgb("+a.color+")":"blue");b.material=new f.MeshLambertMaterial({transparent:1>c,opacity:c,wireframe:!1,color:b.fillcolor,side:f.FrontSide,vertexColors:f.NoColors,depthWrite:1==c});b.material.inherentOpacity=c;return b}if(!this.origin)return console.error("origin not there - kind",b.kind,a.nodeid,b),null;c=this.origin[a.nodeid];if(1===
b.kind)return a={name:k.getObjectName(c),nname:k.getObjectName(c),shape:c.fShape,material:null,chlds:null},null!==c.fElements&&(a.chlds=c.fElements.arr),b=Math.min(1,c.fRGBA[3]),a.fillcolor=new f.Color(c.fRGBA[0],c.fRGBA[1],c.fRGBA[2]),a.material=new f.MeshLambertMaterial({transparent:1>b,opacity:b,wireframe:!1,color:a.fillcolor,side:f.FrontSide,vertexColors:f.NoColors,depthWrite:1==b}),a.material.inherentOpacity=b,a;var d=c.fVolume;b={name:k.getObjectName(d),nname:k.getObjectName(c),volume:c.fVolume,
shape:d.fShape,material:null,chlds:null};null!==c.fVolume.fNodes&&(b.chlds=c.fVolume.fNodes.arr);d&&(b.linewidth=d.fLineWidth);c=1;var e=JSROOT.Painter;e=e?e.root_colors:"white black red green blue yellow magenta cyan".split(" ");a.custom_color?b.fillcolor=a.custom_color:1<d.fFillColor&&1==d.fLineColor?b.fillcolor=e[d.fFillColor]:0<=d.fLineColor&&(b.fillcolor=e[d.fLineColor]);d.fMedium&&d.fMedium.fMaterial&&(a=d.fMedium.fMaterial,d=a.fFillStyle,d=3E3>d||3100<d?0:d-3E3,this.use_dflt_colors&&(b.fillcolor=
e[this.dflt_table[Math.round(a.fZ)]],.1>a.fDensity&&(d=60)),0<d&&(c=(100-d)/100),void 0===b.fillcolor&&(b.fillcolor=e[a.fFillColor]));void 0===b.fillcolor&&(b.fillcolor="lightgrey");b.material=new f.MeshLambertMaterial({transparent:1>c,opacity:c,wireframe:!1,color:b.fillcolor,side:f.FrontSide,vertexColors:f.NoColors,depthWrite:1==c});b.material.inherentOpacity=c;return b};t.prototype.createObject3D=function(a,b,c){for(var d=this.nodes[0],e=b,g=0,k="object"==typeof c||"force"===c,h=0;h<=a.length;++h){var t=
0<h?a[h-1]:0;0<h&&(d=this.nodes[d.chlds[t]]);var l=void 0;if(e.children)for(var m=0;m<e.children.length;++m)if(e.children[m].nchld===t){l=e.children[m];break}if(l)e=l,l.$jsroot_drawable&&g++;else{if(!k)return null;l=new f.Object3D;d.abs_matrix?(l.absMatrix=new f.Matrix4,l.absMatrix.fromArray(d.matrix)):d.matrix&&(l.matrix.fromArray(d.matrix),l.matrix.decompose(l.position,l.quaternion,l.scale));l.nchld=t;e.add(l);0==h&&"object"==typeof c&&c.scale&&(0>c.scale.x||0>c.scale.y||0>c.scale.z)&&(l.scale.copy(c.scale),
l.updateMatrix());l.updateMatrixWorld();e=l}}if("mesh"===c||"delete_mesh"===c){a=null;if(e)for(d=0;d<e.children.length&&!a;++d)g=e.children[d],"Mesh"===g.type&&void 0===g.nchld&&(a=g);if("mesh"===c||!a)return a;for(c=e;a&&a!==b;)e=a.parent,e.remove(a),a=0==e.children.length?e:null;return c}e&&(e.$jsroot_drawable=!0,e.$jsroot_depth=g);return e};t.prototype.getVolumeBoundary=function(a,b,c){var d={min:0,max:1,sortidcut:0};if(!this.sortmap)return console.error("sorting map do not exist"),d;for(var e,
g,f=0,h=0,k=0;k<this.sortmap.length&&f<c&&h<b;++k){var l=this.sortmap[k];0!==a[l]&&(g=this.nodes[l],e||(e=g),f+=a[l],h+=a[l]*g.nfaces)}if(!g)return console.error("no volumes selected"),d;d.max=e.vol;d.min=g.vol;d.sortidcut=g.sortid;return d};t.prototype.collectVisibles=function(a,b){if(this.plain_shape)return{lst:[{nodeid:0,seqid:0,stack:[],factor:1,shapeid:0,server_shape:this.plain_shape}],complete:!0};var c={facecnt:0,viscnt:Array(this.nodes.length),vislvl:this.getVisLevel(),reset:function(){for(var a=
this.facecnt=this.total=0;a<this.viscnt.length;++a)this.viscnt[a]=0},func:function(a){this.total++;this.facecnt+=a.nfaces;this.viscnt[a.id]++;return!0}};c.reset();var d=this.scanVisible(c),e=this.getMaxVisNodes();if(0<e)for(;d>e&&1<c.vislvl;)c.vislvl--,c.reset(),d=this.scanVisible(c);this.actual_level=c.vislvl;var f=0,k=0,h=-1,t=10,l=this.nodes.length+1;console.log("Total visible nodes "+d+" numfaces "+c.facecnt);if(c.facecnt>a&&(d=this.getVolumeBoundary(c.viscnt,a*(b?.8:1),e*(b?.8:1)),f=d.min,k=
d.max,l=d.sortidcut,b)){c.domatrix=!0;c.frustum=b;c.totalcam=0;c.func=function(a){a.vol<=f&&this.frustum.CheckShape(this.getmatrix(),a)&&(this.viscnt[a.id]++,this.totalcam+=a.nfaces);return!0};for(b=0;b<c.viscnt.length;++b)c.viscnt[b]=0;this.scanVisible(c);h=c.totalcam>.2*a?this.getVolumeBoundary(c.viscnt,.2*a,.2*e).min:0;t=k/(0<h?0<h:f)}c.items=[];c.func=function(a){a.sortid<l?this.items.push(this.CopyStack()):0<=h&&a.vol>h&&this.frustum.CheckShape(this.getmatrix(),a)&&this.items.push(this.CopyStack(t));
return!0};this.scanVisible(c);return{lst:c.items,complete:0===f}};t.prototype.mergeVisibles=function(a,b){for(var c=0,d=[],e=0;e<a.length&&c<b.length;++e){for(;c<b.length&&b[c].seqid<a[e].seqid;)d.push(b[c++]);c<b.length&&b[c].seqid===a[e].seqid&&(b[c].done&&(a[e].done=!0),c++)}for(;c<b.length;)d.push(b[c++]);return d};t.prototype.collectShapes=function(a){if(this.plain_shape)return[this.plain_shape];for(var b=[],c=0;c<a.length;++c){var d=a[c],e=this.getNodeShape(d.nodeid);e&&(void 0===e._id?(e._id=
b.length,b.push({id:e._id,shape:e,vol:this.nodes[d.nodeid].vol,refcnt:1,factor:1,ready:!1})):b[e._id].refcnt++,d.shape=b[e._id],d.factor&&d.factor>d.shape.factor&&(d.shape.factor=d.factor))}b.sort(function(a,b){return b.vol*b.factor-a.vol*a.factor});for(c=0;c<b.length;++c)d=b[c],d.id=c,delete d.shape._id;for(c=0;c<a.length;++c)d=a[c],d.shape&&(d.shapeid=d.shape.id,delete d.shape);return b};t.prototype.mergeShapesLists=function(a,b){if(!a)return b;for(var c=0;c<a.length;++c){var d=a[c];d.shape._geom=
d.geom;delete d.geom;void 0!==d.geomZ&&(d.shape._geomZ=d.geomZ,delete d.geomZ)}for(c=0;c<b.length;++c)d=b[c],void 0!==d.shape._geom&&(d.geom=d.shape._geom,delete d.shape._geom),void 0!==d.shape._geomZ&&(d.geomZ=d.shape._geomZ,delete d.shape._geomZ);for(c=0;c<a.length;++c)d=a[c],delete d.shape._geom,delete d.shape._geomZ;return b};t.prototype.buildShapes=function(a,b,c){for(var d=0,e=(new Date).getTime(),f={done:!1,shapes:0,faces:0,notusedshapes:0},k=0;k<a.length;++k){var h=a[k];if(f.done)h.ready=
!0;else if(h.ready||(h._typename="$$Shape$$",h.ready=!0,void 0===h.geom&&(h.geom=Ia(h.shape),h.geom&&d++),h.nfaces=Y(h.geom)),f.shapes++,h.used||f.notusedshapes++,f.faces+=h.nfaces*h.refcnt,f.faces>=b)f.done=!0;else if(d>.01*a.length&&void 0!==c&&(new Date).getTime()-e>c)return f}f.done=!0;return f};k.getObjectName=function(a){return a&&a.fName?a.fName+(a.$geo_suffix?a.$geo_suffix:""):""};k.checkDuplicates=function(a,b){if(a){if(a.$geo_checked)return;a.$geo_checked=!0}a=[];for(var c=[],d=0;d<b.length;++d){var e=
b[d];if(e&&e.fName){if(!e.$geo_suffix){var f=a.indexOf(e.fName);if(0<=f){for(var n=c[f]||1;0<=a.indexOf(e.fName+"#"+n);)++n;e.$geo_suffix="#"+n;c[f]=n+1}}a.push(k.getObjectName(e))}}};k.cleanupShape=function(a){a&&(a.geom&&"function"==typeof a.geom.dispose&&a.geom.dispose(),a.geomZ&&"function"==typeof a.geomZ.dispose&&a.geomZ.dispose(),delete a.geom,delete a.geomZ)};k.produceRenderOrder=function(a,b,c,d){function e(a){a&&a.traverse(function(a){a.renderOrder=0;a.material&&(a.material.depthWrite=!0)})}
function g(a,b,c){if(a.children)for(var d=0;d<a.children.length;++d){var f=a.children[d];f.$jsroot_order===b?f.material&&(f.material.transparent?(f.material.depthWrite=!1,c.push(f)):e(f)):(void 0===a.$jsroot_depth||a.$jsroot_depth<b)&&g(f,b,c)}}function k(a,e,g){if(300<a.length){for(var h=0;h<a.length;++h)a[h].renderOrder=(e+g)/2;return!1}h=new f.Vector3;for(var k=0;k<a.length;++k){var n=a[k],l=n.$jsroot_box3;l||(n.$jsroot_box3=l=Xb(n));if("size"===c)n.$jsroot_distance=l.getSize(new f.Vector3);else if("pnt"===
c)n.$jsroot_distance=b.distanceTo(l.getCenter(h));else{var m=Math.min(b.distanceTo(l.min),b.distanceTo(l.max)),p=new f.Vector3(l.min.x,l.min.y,l.max.z);m=Math.min(m,b.distanceTo(p));p.set(l.min.x,l.max.y,l.min.z);m=Math.min(m,b.distanceTo(p));p.set(l.max.x,l.min.y,l.min.z);m=Math.min(m,b.distanceTo(p));p.set(l.max.x,l.max.y,l.min.z);m=Math.min(m,b.distanceTo(p));p.set(l.max.x,l.min.y,l.max.z);m=Math.min(m,b.distanceTo(p));p.set(l.min.x,l.max.y,l.max.z);m=Math.min(m,b.distanceTo(p));n.$jsroot_distance=
m}}a.sort(function(a,b){return a.$jsroot_distance-b.$jsroot_distance});k=Array(a.length);for(n=0;n<a.length;++n)a[n].$jsroot_index=n,k[n]=a[n];if("ray"===c)for(n=a.length-1;0<=n;--n){l=a[n];p=l.$jsroot_box3.getCenter(h);for(m=0;2>m;++m){p.sub(b).normalize();t.set(b,p);p=t.intersectObjects(a,!1);for(var r=[],v=0;v<p.length;++v)0>r.indexOf(p[v].object)&&r.push(p[v].object);p=r;0>p.indexOf(l)&&0<m&&console.log("MISS",d?d.resolveStack(l.stack).name:"???");if(0<=p.indexOf(l)||0<m)break;p=l.geometry.attributes.position.array;
p=new f.Vector3((p[0]+p[3]+p[6])/3,(p[1]+p[4]+p[7])/3,(p[2]+p[5]+p[8])/3);p.applyMatrix4(l.matrixWorld)}for(l=0;l<intersects.length-1;++l)if(m=intersects[l+1],p=intersects[l].$jsroot_index,r=m.$jsroot_index,!(p<r)){for(;r<p;++r)k[r]=k[r+1],k[r].$jsroot_index=r;k[p]=m;m.$jsroot_index=p}}for(a=0;a<k.length;++a)k[a].renderOrder=g-(a+1)/(k.length+1)*(g-e),delete k[a].$jsroot_index,delete k[a].$jsroot_distance;return!0}function h(a,b,c,d){var e=[],f=!1;g(a,b,e);if(e.length){if(c===d)for(a=0;a<e.length;++a)e[a].renderOrder=
c;else(f=k(e,c,d))||(c=d=(c+d)/2);for(a=0;a<e.length;++a){var n=e[a].parent,l=c,m=d;f&&(m=e[a].renderOrder,l=m-(d-c)/(e.length+2));h(n,b+1,l,m)}}}var t=new f.Raycaster;c&&"dflt"!==c?h(a,0,1,1E6):e(a)};k.build=function(a,b){if(!a)return null;b||(b={});b.numfaces||(b.numfaces=1E5);b.numnodes||(b.numnodes=1E3);b.frustum||(b.frustum=null);b.res_mesh=b.res_faces=0;var c=null,d=!1;"fShapeBits"in a&&"fShapeId"in a?(c=a,a=null):"TGeoVolumeAssembly"===a._typename||"TGeoVolume"===a._typename?c=a.fShape:"TEveGeoShapeExtract"===
a._typename||"ROOT::Experimental::REveGeoShapeExtract"===a._typename?c=a.fShape:"TGeoManager"===a._typename?(a=a.fMasterVolume,d=!b.showtop,c=a.fShape):a.fVolume?c=a.fVolume.fShape:a=null;b.composite&&c&&"TGeoCompositeShape"==c._typename&&c.fNode&&(a=k.buildCompositeVolume(c));!a&&c&&(a=JSROOT.extend(JSROOT.create("TEveGeoShapeExtract"),{fTrans:null,fShape:c,fRGBA:[0,1,0,1],fElements:null,fRnrSelf:!0}));if(!a)return null;0===a._typename.indexOf("TGeoVolume")&&(a={_typename:"TGeoNode",fVolume:a,fName:a.fName,
$geoh:a.$geoh,_proxy:!0});a=new t(a);a.setVisLevel(b.vislevel);a.setMaxVisNodes(b.numnodes);b.dflt_colors&&a.setDefaultColors(!0);0>=(b.no_screen?0:a.markVisibles(!0))?a.markVisibles(!1,!1,d):a.markVisibles(!0,!0,d);a.produceIdShifts();d=a.collectVisibles(b.numfaces,b.frustum).lst;c=a.collectShapes(d);a.buildShapes(c,b.numfaces);for(var e=new f.Object3D,g=0;g<d.length;++g){var n=d[g];if(!n.done){var h=c[n.shapeid];if(!h.ready){console.warn("shape marked as not ready when should");break}n.done=!0;
h.used=!0;if(h.geom&&0!==h.nfaces){var v=a.getDrawEntryProperties(n);b.res_mesh++;b.res_faces+=h.nfaces;var l=a.createObject3D(n.stack,e,b);v.material.wireframe=b.wireframe;v.material.side=b.doubleside?f.DoubleSide:f.FrontSide;h=-.9<(l.absMatrix||l.matrixWorld).determinant()?new f.Mesh(h.geom,v.material):Wb(h,v.material);h.name=a.getNodeName(n.nodeid);l.add(h);l.absMatrix&&(h.matrix.copy(l.absMatrix),h.matrix.decompose(l.position,l.quaternion,l.scale),h.updateMatrixWorld())}else a.createObject3D(n.stack,
e,"delete_mesh")}}return e};k.projectGeometry=function(a,b,c,d,e){a.boundingBox||a.computeBoundingBox();var f=a.boundingBox.clone();f.applyMatrix4(b);d||(d=0);if(f.min[c]>=d&&f.max[c]>=d||f.min[c]<=d&&f.max[c]<=d)return null;a=new y.Geometry(a,b,0,e);b=2*Math.max(Math.abs(f.min.x),Math.abs(f.max.x));e=2*Math.max(Math.abs(f.min.y),Math.abs(f.max.y));f=2*Math.max(Math.abs(f.min.z),Math.abs(f.max.z));var k=1E4;switch(c){case "x":k=Math.max(e,f);break;case "y":k=Math.max(b,f);break;case "z":k=Math.max(b,
e)}c=y.CreateNormal(c,d,k);a.cut_from_plane(c);return c.toBufferGeometry()};k.countGeometryFaces=Y;k.createGeometry=Ia;k.createProjectionMatrix=Vb;k.createFrustum=function(a){if(!a)return null;a instanceof f.PerspectiveCamera&&(a=Vb(a));var b=new f.Frustum;b.setFromProjectionMatrix(a);b.corners=new Float32Array([1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,0,0,0]);b.test=new f.Vector3(0,0,0);b.CheckShape=function(a,b){var c=this.test,d=this.corners.length,f=this.corners,h;for(h=0;h<
d;h+=3)if(c.x=f[h]*b.fDX,c.y=f[h+1]*b.fDY,c.z=f[h+2]*b.fDZ,this.containsPoint(c.applyMatrix4(a)))return!0;return!1};b.CheckBox=function(a){var b=this.test,c=0;b.set(a.min.x,a.min.y,a.min.z);this.containsPoint(b)&&c++;b.set(a.min.x,a.min.y,a.max.z);this.containsPoint(b)&&c++;b.set(a.min.x,a.max.y,a.min.z);this.containsPoint(b)&&c++;b.set(a.min.x,a.max.y,a.max.z);this.containsPoint(b)&&c++;b.set(a.max.x,a.max.y,a.max.z);this.containsPoint(b)&&c++;b.set(a.max.x,a.min.y,a.max.z);this.containsPoint(b)&&
c++;b.set(a.max.x,a.max.y,a.min.z);this.containsPoint(b)&&c++;b.set(a.max.x,a.max.y,a.max.z);this.containsPoint(b)&&c++;return 5<c};return b};k.createFlippedMesh=Wb;k.getBoundingBox=Xb;k.provideObjectInfo=Ub;k.ClonedNodes=t;JSROOT.GEO=k;JSROOT.nodejs&&(module.exports=k);return k});
