var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(n,g,e){n!=Array.prototype&&n!=Object.prototype&&(n[g]=e.value)};$jscomp.getGlobal=function(n){return"undefined"!=typeof window&&window===n?n:"undefined"!=typeof global&&null!=global?global:n};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(n,g,e,M){if(g){e=$jscomp.global;n=n.split(".");for(M=0;M<n.length-1;M++){var C=n[M];C in e||(e[C]={});e=e[C]}n=n[n.length-1];M=e[n];g=g(M);g!=M&&null!=g&&$jscomp.defineProperty(e,n,{configurable:!0,writable:!0,value:g})}};$jscomp.polyfill("Number.isFinite",function(n){return n?n:function(g){return"number"!==typeof g?!1:!isNaN(g)&&Infinity!==g&&-Infinity!==g}},"es6","es3");
$jscomp.polyfill("Number.isInteger",function(n){return n?n:function(g){return Number.isFinite(g)?g===Math.floor(g):!1}},"es6","es3");$jscomp.arrayIteratorImpl=function(n){var g=0;return function(){return g<n.length?{done:!1,value:n[g++]}:{done:!0}}};$jscomp.arrayIterator=function(n){return{next:$jscomp.arrayIteratorImpl(n)}};$jscomp.makeIterator=function(n){var g="undefined"!=typeof Symbol&&Symbol.iterator&&n[Symbol.iterator];return g?g.call(n):$jscomp.arrayIterator(n)};
$jscomp.FORCE_POLYFILL_PROMISE=!1;
$jscomp.polyfill("Promise",function(n){function g(){this.batch_=null}function e(e){return e instanceof C?e:new C(function(g,a){g(e)})}if(n&&!$jscomp.FORCE_POLYFILL_PROMISE)return n;g.prototype.asyncExecute=function(e){if(null==this.batch_){this.batch_=[];var g=this;this.asyncExecuteFunction(function(){g.executeBatch_()})}this.batch_.push(e)};var M=$jscomp.global.setTimeout;g.prototype.asyncExecuteFunction=function(e){M(e,0)};g.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var e=
this.batch_;this.batch_=[];for(var g=0;g<e.length;++g){var a=e[g];e[g]=null;try{a()}catch(c){this.asyncThrow_(c)}}}this.batch_=null};g.prototype.asyncThrow_=function(e){this.asyncExecuteFunction(function(){throw e;})};var C=function(e){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var g=this.createResolveAndReject_();try{e(g.resolve,g.reject)}catch(a){g.reject(a)}};C.prototype.createResolveAndReject_=function(){function e(c){return function(d){a||(a=!0,c.call(g,d))}}var g=this,a=!1;
return{resolve:e(this.resolveTo_),reject:e(this.reject_)}};C.prototype.resolveTo_=function(e){if(e===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(e instanceof C)this.settleSameAsPromise_(e);else{a:switch(typeof e){case "object":var g=null!=e;break a;case "function":g=!0;break a;default:g=!1}g?this.resolveToNonPromiseObj_(e):this.fulfill_(e)}};C.prototype.resolveToNonPromiseObj_=function(e){var g=void 0;try{g=e.then}catch(a){this.reject_(a);return}"function"==typeof g?
this.settleSameAsThenable_(g,e):this.fulfill_(e)};C.prototype.reject_=function(e){this.settle_(2,e)};C.prototype.fulfill_=function(e){this.settle_(1,e)};C.prototype.settle_=function(e,g){if(0!=this.state_)throw Error("Cannot settle("+e+", "+g+"): Promise already settled in state"+this.state_);this.state_=e;this.result_=g;this.executeOnSettledCallbacks_()};C.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var e=0;e<this.onSettledCallbacks_.length;++e)ja.asyncExecute(this.onSettledCallbacks_[e]);
this.onSettledCallbacks_=null}};var ja=new g;C.prototype.settleSameAsPromise_=function(e){var g=this.createResolveAndReject_();e.callWhenSettled_(g.resolve,g.reject)};C.prototype.settleSameAsThenable_=function(e,g){var a=this.createResolveAndReject_();try{e.call(g,a.resolve,a.reject)}catch(c){a.reject(c)}};C.prototype.then=function(e,g){function a(a,b){return"function"==typeof a?function(b){try{c(a(b))}catch(u){d(u)}}:b}var c,d,b=new C(function(a,b){c=a;d=b});this.callWhenSettled_(a(e,c),a(g,d));
return b};C.prototype.catch=function(e){return this.then(void 0,e)};C.prototype.callWhenSettled_=function(e,g){function a(){switch(c.state_){case 1:e(c.result_);break;case 2:g(c.result_);break;default:throw Error("Unexpected state: "+c.state_);}}var c=this;null==this.onSettledCallbacks_?ja.asyncExecute(a):this.onSettledCallbacks_.push(a)};C.resolve=e;C.reject=function(e){return new C(function(g,a){a(e)})};C.race=function(g){return new C(function(n,a){for(var c=$jscomp.makeIterator(g),d=c.next();!d.done;d=
c.next())e(d.value).callWhenSettled_(n,a)})};C.all=function(g){var n=$jscomp.makeIterator(g),a=n.next();return a.done?e([]):new C(function(c,d){function b(a){return function(b){E[a]=b;g--;0==g&&c(E)}}var E=[],g=0;do E.push(void 0),g++,e(a.value).callWhenSettled_(b(E.length-1),d),a=n.next();while(!a.done)})};return C},"es6","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};
$jscomp.SymbolClass=function(n,g){this.$jscomp$symbol$id_=n;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:g})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};$jscomp.Symbol=function(){function n(e){if(this instanceof n)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(e||"")+"_"+g++,e)}var g=0;return n}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var n=$jscomp.global.Symbol.iterator;n||(n=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[n]&&$jscomp.defineProperty(Array.prototype,n,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var n=$jscomp.global.Symbol.asyncIterator;n||(n=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(n){$jscomp.initSymbolIterator();n={next:n};n[$jscomp.global.Symbol.iterator]=function(){return this};return n};
$jscomp.iteratorFromArray=function(n,g){$jscomp.initSymbolIterator();n instanceof String&&(n+="");var e=0,M={next:function(){if(e<n.length){var C=e++;return{value:g(C,n[C]),done:!1}}M.next=function(){return{done:!0,value:void 0}};return M.next()}};M[Symbol.iterator]=function(){return M};return M};$jscomp.polyfill("Array.prototype.entries",function(n){return n?n:function(){return $jscomp.iteratorFromArray(this,function(g,e){return[g,e]})}},"es6","es3");
JSROOT.define(["d3","painter","base3d","latex","hist"],function(n,g,e,M){function C(a,c,d,b){if(c&&c.children)for(var e=0;e<c.children.length;++e){var g=c.children[e];if(g.axis_draw)break;g=void 0}if(g)if(a){d=d?!0:!1;b=b?!0:!1;var m=1;a=a.position;0>a.x&&0<=a.y&&(m=2);0<=a.x&&0<=a.y&&(m=3);0<=a.x&&0>a.y&&(m=4);a=function(a,b){a<=m&&(a+=4);return a>m&&a<m+b};for(c=0;c<g.children.length;++c)if(e=g.children[c],e.grid)e.visible=b&&a(e.grid,3);else if(e.zid)e.visible=a(e.zid,2);else if(e.xyid)e.visible=
a(e.xyid,3);else if(e.xyboxid){var u=5,p=0;b&&!d?(u=3,p=-2):d&&!b?u=3:d||b||(u=e.bottom?3:0);e.visible=a(e.xyboxid+p,u);!e.visible&&e.bottom&&b&&(e.visible=a(e.xyboxid,3))}else e.zboxid&&(u=2,p=0,d&&b?u=5:b&&!d?u=4:!b&&d&&(p=-2,u=4),e.visible=a(e.zboxid+p,u))}else c.remove(g)}function ja(a,c){var d=a.getPadPainter().getRootPad(!0),b=Math.max(.75*a.size_x3d,a.size_z3d),e=Math.max(.75*a.size_y3d,a.size_z3d);c&&(b===e?a.camera.position.set(-1.6*b,-3.5*e,1.4*a.size_z3d):b>e?a.camera.position.set(-2*b,
-3.5*e,1.4*a.size_z3d):a.camera.position.set(-3.5*b,-2*e,1.4*a.size_z3d));if(d&&(c||!a.zoomChangedInteractive())&&Number.isFinite(d.fTheta)&&Number.isFinite(d.fPhi)&&(d.fTheta!==a.camera_Theta||d.fPhi!==a.camera_Phi)){b=3*Math.max(a.size_x3d,a.size_z3d);e=3*Math.max(a.size_y3d,a.size_z3d);c=(-d.fPhi-90)/180*Math.PI;var g=d.fTheta/180*Math.PI;a.camera_Phi=d.fPhi;a.camera_Theta=d.fTheta;a.camera.position.set(b*Math.cos(c)*Math.cos(g),e*Math.sin(c)*Math.cos(g),a.size_z3d+.5*(b+e)*Math.sin(g));c=!0}c&&
a.camera.lookAt(a.lookat)}function O(a,c){JSROOT.THistPainter.call(this,a,c);this.mode3d=!0}function ia(a,c){JSROOT.ObjectPainter.call(this,a,c)}JSROOT.TFramePainter.prototype.create3DScene=function(a,c,d){if(-1===a)this.mode3d&&(this.clear3dCanvas?(C(null,this.toplevel),this.clear3dCanvas(),g.disposeThreejsObject(this.scene),this.control&&this.control.cleanup(),g.cleanupRender3D(this.renderer),delete this.size_x3d,delete this.size_y3d,delete this.size_z3d,delete this.tooltip_mesh,delete this.scene,
delete this.toplevel,delete this.camera,delete this.pointLight,delete this.renderer,delete this.control,this.render_tmout&&(clearTimeout(this.render_tmout),delete this.render_tmout),this.mode3d=!1):console.error("Strange, why mode3d is configured!!!!",this.mode3d));else if(this.mode3d=!0,"toplevel"in this)this.scene.remove(this.toplevel),g.disposeThreejsObject(this.toplevel),delete this.tooltip_mesh,delete this.toplevel,this.control&&this.control.HideTooltip(),a=new e.Object3D,this.scene.add(a),this.toplevel=
a,this.resize3D(),ja(this,!1);else{a=g.getRender3DKind(a);g.assign3DHandler(this);var b=this.getSizeFor3d(void 0,a);this.size_z3d=100;this.size_x3d=this.size_y3d=10<b.height&&10<b.width?Math.round(b.width/b.height*this.size_z3d):this.size_z3d;c&&(this.size_x3d*=c);d&&(this.size_y3d*=d);this.scene=new e.Scene;this.toplevel=new e.Object3D;this.scene.add(this.toplevel);this.scene_width=b.width;this.scene_height=b.height;this.camera=new e.PerspectiveCamera(45,this.scene_width/this.scene_height,1,40*this.size_z3d);
this.camera_Theta=this.camera_Phi=30;this.pointLight=new e.PointLight(16777215,1);this.camera.add(this.pointLight);this.pointLight.position.set(this.size_x3d/2,this.size_y3d/2,this.size_z3d/2);this.lookat=new e.Vector3(0,0,.8*this.size_z3d);this.camera.up=new e.Vector3(0,0,1);this.scene.add(this.camera);ja(this,!0);this.renderer=g.createRender3D(this.scene_width,this.scene_height,a);this.webgl=a===JSROOT.constants.Render3D.WebGL;this.add3dCanvas(b,this.renderer.jsroot_dom,this.webgl);this.first_render_tm=
0;this.enable_highlight=!1;if(!JSROOT.batch_mode&&this.webgl){this.control=g.createOrbitControl(this,this.camera,this.scene,this.renderer,this.lookat);var E=this,R=this.getMainPainter();this.control.ProcessMouseMove=function(a){for(var b=null,c=null,d=null,e=0;e<a.length;++e)if(a[e].object.tooltip){if(b=a[e].object.tooltip(a[e])){c=a[e].object;break}}else a[e].object.zoom&&!d&&(d=a[e].object);if(b&&!b.use_itself){a=1E-4*E.size_x3d;e=1E-4*E.size_y3d;var f=1E-4*E.size_z3d;(b.x1>b.x2||b.y1>b.y2||b.z1>
b.z2)&&console.warn("check 3D hints coordinates");b.x1-=a;b.x2+=a;b.y1-=e;b.y2+=e;b.z1-=f;b.z2+=f}E.highlightBin3D(b,c);return!b&&d&&E.get3dZoomCoord?(c=d.globalIntersect(this.raycaster),b=d.zoom,c=E.get3dZoomCoord(c,b),"z"===b&&d.use_y_for_z&&(b="y"),d=E.getAxis(b),a={name:b,title:"TAxis",line:"any info",only_status:!0},d&&(a.name=d.fName,a.title=d.fTitle||"histogram TAxis object"),a.line=b+" : "+E.axisAsText(b,c),a):b&&b.lines?b:""};this.control.ProcessMouseLeave=function(){E.highlightBin3D(null)};
this.control.contextMenu=function(a,b){var d="painter",c=R;if(b)for(var e=0;e<b.length;++e){var f=b[e].object;if(f.zoom){d=f.zoom;c=null;break}if(f.painter&&"function"===typeof f.painter.fillContextMenu){c=f.painter;break}}(b=R.getFramePainter())&&b.showContextMenu&&b.showContextMenu(d,a,c)}}}};JSROOT.TFramePainter.prototype.render3D=function(a){var c=this;if(-1111===a){var d=JSROOT._.get_document();a=e.CreateSVGRenderer(!1,0,d);a.setSize(this.scene_width,this.scene_height);a.render(this.scene,this.camera);
return a.makeOuterHTML?(d=d.createElement("div"),d.innerHTML=a.makeOuterHTML(),d.childNodes[0]):a.domElement}void 0===a&&(a=5);0<a&&!this.usesvg&&!JSROOT.batch_mode?this.render_tmout||(this.render_tmout=setTimeout(function(){return c.render3D(0)},a)):(this.render_tmout&&(clearTimeout(this.render_tmout),delete this.render_tmout),this.renderer&&(g.beforeRender3D(this.renderer),a=new Date,this.opt3d||(this.opt3d={FrontBox:!0,BackBox:!0}),C(this.camera,this.toplevel,this.opt3d.FrontBox,this.opt3d.BackBox),
this.renderer.render(this.scene,this.camera),g.afterRender3D(this.renderer),d=new Date,0===this.first_render_tm&&(this.first_render_tm=d.getTime()-a.getTime(),this.enable_highlight=1200>this.first_render_tm&&this.isTooltipAllowed(),console.log("three.js r"+e.REVISION+", first render tm = "+this.first_render_tm))))};JSROOT.TFramePainter.prototype.resize3D=function(){var a=this.getSizeFor3d(this.access3dKind());this.apply3dSize(a);if(this.scene_width===a.width&&this.scene_height===a.height||10>a.width||
10>a.height)return!1;this.scene_width=a.width;this.scene_height=a.height;this.camera.aspect=this.scene_width/this.scene_height;this.camera.updateProjectionMatrix();this.renderer.setSize(this.scene_width,this.scene_height);this.renderer.setJSROOTSize&&this.renderer.setJSROOTSize(this.scene_width,this.scene_height);return!0};JSROOT.TFramePainter.prototype.highlightBin3D=function(a,c){var d=!1,b=null,E=!0,R=!a||void 0===a.x1||!this.enable_highlight,m=this.getMainPainter();!m||m.provideUserTooltip&&m.hasUserTooltip()||
(m=null);this.tooltip_selfmesh&&(E=this.tooltip_selfmesh!==c,this.tooltip_selfmesh.material.color=this.tooltip_selfmesh.save_color,delete this.tooltip_selfmesh,d=!0);this.tooltip_mesh&&(b=this.tooltip_mesh,this.toplevel.remove(this.tooltip_mesh),delete this.tooltip_mesh,d=!0);if(R)d&&this.render3D(),d&&m&&m.provideUserTooltip(null);else{if(a.use_itself)c.save_color=c.material.color,c.material.color=new e.Color(a.color),this.tooltip_selfmesh=c,d=E;else{d=!0;c=g.Box3D.Indexes;E=g.Box3D.Normals;R=g.Box3D.Vertices;
var u=new e.Color(a.color?a.color:16711680),p=a.opacity||1;if(b){var k=b.geometry.attributes.position.array;b.geometry.attributes.position.needsUpdate=!0;b.material.color=u;b.material.opacity=p}else{k=new Float32Array(3*c.length);var q=new Float32Array(3*c.length);b=new e.BufferGeometry;b.setAttribute("position",new e.BufferAttribute(k,3));b.setAttribute("normal",new e.BufferAttribute(q,3));u=new e.MeshBasicMaterial({color:u,opacity:p});b=new e.Mesh(b,u)}a.x1===a.x2&&console.warn("same tip X",a.x1,
a.x2);a.y1===a.y2&&console.warn("same tip Y",a.y1,a.y2);a.z1===a.z2&&(a.z2=a.z1+1E-4);u=0;for(p=-3;u<c.length;++u){var f=R[c[u]];k[3*u]=a.x1+f.x*(a.x2-a.x1);k[3*u+1]=a.y1+f.y*(a.y2-a.y1);k[3*u+2]=a.z1+f.z*(a.z2-a.z1);q&&(0===u%6&&(p+=3),q[3*u]=E[p],q[3*u+1]=E[p+1],q[3*u+2]=E[p+2])}this.tooltip_mesh=b;this.toplevel.add(b)}d&&this.render3D();d&&a.$painter&&"function"==typeof a.$painter.redrawProjection&&a.$painter.redrawProjection(a.ix-1,a.ix,a.iy-1,a.iy);d&&m&&m.getObject()&&m.provideUserTooltip({obj:m.getObject(),
name:m.getObject().fName,bin:a.bin,cont:a.value,binx:a.ix,biny:a.iy,binz:a.iz,grx:(a.x1+a.x2)/2,gry:(a.y1+a.y2)/2,grz:(a.z1+a.z2)/2})}};JSROOT.TFramePainter.prototype.set3DOptions=function(a){this.opt3d=a};JSROOT.TFramePainter.prototype.drawXYZ=function(a,c){c||(c={});var d=-this.size_x3d,b=this.size_x3d,E=-this.size_y3d,R=this.size_y3d,m=0,u=2*this.size_z3d,p=Math.round(.05*this.size_z3d),k=this.getPadPainter().getRootPad(!0),q=this.xmin,f=this.xmax,z=this.ymin,t=this.ymax,l=this.zmin,v=this.zmax,
w=!1,r=!1;this.size_z3d||(d=this.xmin,b=this.xmax,E=this.ymin,R=this.ymax,m=this.zmin,u=this.zmax,p=.05*(u-m));"zoom_xmin"in this&&"zoom_xmax"in this&&this.zoom_xmin!==this.zoom_xmax&&(q=this.zoom_xmin,f=this.zoom_xmax);"zoom_ymin"in this&&"zoom_ymax"in this&&this.zoom_ymin!==this.zoom_ymax&&(z=this.zoom_ymin,t=this.zoom_ymax,w=!0);"zoom_zmin"in this&&"zoom_zmax"in this&&this.zoom_zmin!==this.zoom_zmax&&(l=this.zoom_zmin,v=this.zoom_zmax,r=!0);c.use_y_for_z&&(this.zmin=this.ymin,this.zmax=this.ymax,
l=z,v=t,r=w,z=0,t=1);this.lego_zmin=l;this.lego_zmax=v;void 0===c.zmult||r||(v*=c.zmult);this.x_handle=new JSROOT.TAxisPainter(null,this.xaxis);this.x_handle.configureAxis("xaxis",this.xmin,this.xmax,q,f,!1,[d,b],{log:k?k.fLogx:0});this.x_handle.assignFrameMembers(this,"x");this.y_handle=new JSROOT.TAxisPainter(null,this.yaxis);this.y_handle.configureAxis("yaxis",this.ymin,this.ymax,z,t,!1,[E,R],{log:k&&!c.use_y_for_z?k.fLogy:0});this.y_handle.assignFrameMembers(this,"y");this.z_handle=new JSROOT.TAxisPainter(null,
this.zaxis);this.z_handle.configureAxis("zaxis",this.zmin,this.zmax,l,v,!1,[m,u],{log:k?k.fLogz:0});this.z_handle.assignFrameMembers(this,"z");this.setRootPadRange(k,!0);this.x_handle.debug=!0;var y=new e.MeshBasicMaterial({color:0});k=new e.LineBasicMaterial({color:0});var h=.5*p;f=[];var x=1;z=this.x_handle.createTicks(!1,!0);l=this.y_handle.createTicks(!1,!0);t=this.z_handle.createTicks(!1,!0);q=new e.Object3D;q.axis_draw=!0;a.add(q);a=[];var B=0;for(v=this.xaxis;z.next();){w=z.grpos;r=1===z.kind;
var A=this.x_handle.format(z.tick,2);z.last_major()?v&&v.fTitle||(A="x"):null===A&&(r=!1,A="");if(r&&A&&0<A.length){A=new e.TextGeometry(A,{font:JSROOT.threejs_font_helvetiker_regular,size:p,height:0,curveSegments:5});A.computeBoundingBox();var I=A.boundingBox.max.x-A.boundingBox.min.x,n=A.boundingBox.max.y-A.boundingBox.min.y;A.center=!0;B=Math.max(B,n);A.grx=w;f.push(A);z.last_major()||(n=z.next_major_grpos()-w,0<I&&(x=Math.min(x,.9*n/I)),this.x_handle.isCenteredLabels()&&(A.grx+=n/2))}a.push(w,
0,0,w,r?-h:.6*-h,0)}v&&v.fTitle&&(z=new e.TextGeometry(M.translateLaTeX(v.fTitle),{font:JSROOT.threejs_font_helvetiker_regular,size:p,height:0,curveSegments:5}),z.computeBoundingBox(),z.center=v.TestBit(JSROOT.EAxisBits.kCenterTitle),z.gry=2,z.grx=(d+b)/2,f.push(z));this.get3dZoomCoord=function(a,b){a=a[b];var d=this["scale_"+b+"min"],c=this["scale_"+b+"max"];switch(b){case "x":a=(a+this.size_x3d)/2/this.size_x3d;break;case "y":a=(a+this.size_y3d)/2/this.size_y3d;break;case "z":a=a/2/this.size_z3d}return a=
this["log"+b]?Math.exp(Math.log(d)+a*(Math.log(c)-Math.log(d))):d+a*(c-d)};z=function(a,b,d){var c=new e.BufferGeometry;var f="z"===a?new Float32Array([0,0,0,4*h,0,2*b,4*h,0,0,0,0,0,0,0,2*b,4*h,0,2*b]):new Float32Array([-b,0,0,b,4*-h,0,b,0,0,-b,0,0,-b,4*-h,0,b,4*-h,0]);c.setAttribute("position",new e.BufferAttribute(f,3));c.computeVertexNormals();var k=new e.MeshBasicMaterial({transparent:!0,vertexColors:e.NoColors,side:e.DoubleSide,opacity:0});c=new e.Mesh(c,k);c.zoom=a;c.size_3d=b;c.use_y_for_z=
d;"y"==a&&c.rotateZ(Math.PI/2).rotateX(Math.PI);c.v1=new e.Vector3(f[0],f[1],f[2]);c.v2=new e.Vector3(f[6],f[7],f[8]);c.v3=new e.Vector3(f[3],f[4],f[5]);c.globalIntersect=function(a){if(this.v1&&this.v2&&this.v3){var b=new e.Plane;b.setFromCoplanarPoints(this.v1,this.v2,this.v3);b.applyMatrix4(this.matrixWorld);var c=a.ray.origin.clone();a=c.clone().addScaledVector(a.ray.direction,1E10);if(b=b.intersectLine(new e.Line3(c,a),new e.Vector3))return c=-this.size_3d,a=this.size_3d,"z"===this.zoom&&(c=
0,a=2*this.size_3d),b[this.zoom]<c?b[this.zoom]=c:b[this.zoom]>a&&(b[this.zoom]=a),b}};c.showSelection=function(a,b){var c=this.children?this.children[0]:null,d=this.zoom;if(!a||!b)return c&&(this.remove(c),g.disposeThreejsObject(c)),c;if(!this.geometry)return!1;if(c)var f=c.geometry;else f=this.geometry.clone(),c=f.getAttribute("position").array,"z"===d?c[6]=c[3]=c[15]=h:c[4]=c[16]=c[13]=-h,c=new e.Mesh(f,new e.MeshBasicMaterial({color:65280,side:e.DoubleSide})),this.add(c);c=f.getAttribute("position").array;
"z"==d?(c[2]=c[11]=c[8]=a[d],c[5]=c[17]=c[14]=b[d]):(c[0]=c[9]=c[12]=a[d],c[6]=c[3]=c[15]=b[d]);f.getAttribute("position").needsUpdate=!0;f.computeFaceNormals();return!0};return c};var J=new e.Object3D;J.position.set(0,E,m);J.rotation.x=.25*Math.PI;J.xyid=2;a=g.createLineSegments(a,k);J.add(a);f.forEach(function(a){var c=a.boundingBox.max.x-a.boundingBox.min.x,d=a.center?a.grx-c/2:b-c;c=new e.Matrix4;c.set(x,0,0,d,0,x,0,(-B*x-1.5*h)*(a.gry||1),0,0,1,0,0,0,0,1);a=new e.Mesh(a,y);a.applyMatrix4(c);
J.add(a)});c.zoom&&J.add(z("x",this.size_x3d));q.add(J);J=new e.Object3D;J.position.set(0,R,m);J.rotation.x=.75*Math.PI;J.add(new e.LineSegments(a.geometry,k));f.forEach(function(a){var c=a.boundingBox.max.x-a.boundingBox.min.x,d=a.center?a.grx+c/2:b;c=new e.Matrix4;c.set(-x,0,0,d,0,x,0,(-B*x-1.5*h)*(a.gry||1),0,0,-1,0,0,0,0,1);a=new e.Mesh(a,y);a.applyMatrix4(c);J.add(a)});J.xyid=4;c.zoom&&J.add(z("x",this.size_x3d));q.add(J);f=[];x=1;B=0;a=[];for(v=this.yaxis;l.next();)w=l.grpos,r=1===l.kind,A=
this.y_handle.format(l.tick,2),l.last_major()?v&&v.fTitle||(A="y"):null===A&&(r=!1,A=""),r&&(A=new e.TextGeometry(A,{font:JSROOT.threejs_font_helvetiker_regular,size:p,height:0,curveSegments:5}),A.computeBoundingBox(),I=A.boundingBox.max.x-A.boundingBox.min.x,n=A.boundingBox.max.y-A.boundingBox.min.y,A.center=!0,B=Math.max(B,n),A.gry=w,f.push(A),l.last_major()||(n=l.next_major_grpos()-w,0<I&&(x=Math.min(x,.9*n/I)),this.y_handle.isCenteredLabels()&&(A.gry+=n/2))),a.push(0,w,0,r?-h:.6*-h,w,0);v&&v.fTitle&&
(l=new e.TextGeometry(M.translateLaTeX(v.fTitle),{font:JSROOT.threejs_font_helvetiker_regular,size:p,height:0,curveSegments:5}),l.computeBoundingBox(),l.center=v.TestBit(JSROOT.EAxisBits.kCenterTitle),l.grx=2,l.gry=(E+R)/2,f.push(l));if(!c.use_y_for_z){a=g.createLineSegments(a,k);var D=new e.Object3D;D.position.set(d,0,m);D.rotation.y=-.25*Math.PI;D.add(a);f.forEach(function(a){var c=a.boundingBox.max.x-a.boundingBox.min.x,b=a.center?a.gry+c/2:R;c=new e.Matrix4;c.set(0,x,0,(-B*x-1.5*h)*(a.grx||1),
-x,0,0,b,0,0,1,0,0,0,0,1);a=new e.Mesh(a,y);a.applyMatrix4(c);D.add(a)});D.xyid=3;c.zoom&&D.add(z("y",this.size_y3d));q.add(D);D=new e.Object3D;D.position.set(b,0,m);D.rotation.y=-.75*Math.PI;D.add(new e.LineSegments(a.geometry,k));f.forEach(function(a){var c=a.boundingBox.max.x-a.boundingBox.min.x,b=a.center?a.gry-c/2:R-c;c=new e.Matrix4;c.set(0,x,0,(-B*x-1.5*h)*(a.grx||1),x,0,0,b,0,0,-1,0,0,0,0,1);a=new e.Mesh(a,y);a.applyMatrix4(c);D.add(a)});D.xyid=1;c.zoom&&D.add(z("y",this.size_y3d));q.add(D)}f=
[];x=1;a=[];A=w=r=null;l=this.zaxis;v=0;this.size_z3d&&(r=[],w=[]);for(;t.next();){I=t.grpos;n=1==t.kind;var H=this.z_handle.format(t.tick,2);null===H&&(n=!1,H="");if(n&&H){H=new e.TextGeometry(H,{font:JSROOT.threejs_font_helvetiker_regular,size:p,height:0,curveSegments:5});H.computeBoundingBox();var F=H.boundingBox.max.x-H.boundingBox.min.x,C=H.boundingBox.max.y-H.boundingBox.min.y;H.translate(-F,-C/2,0);H.grz=I;f.push(H);null!==A&&0<C&&(x=Math.min(x,.9*(I-A)/C));v=Math.max(v,F);A=I}r&&n&&r.push(d,
0,I,b,0,I);w&&n&&w.push(0,E,I,0,R,I);a.push(0,0,I,n?h:.6*h,0,I)}r&&0<r.length&&(t=new e.LineDashedMaterial({color:0,dashSize:2,gapSize:2}),r=g.createLineSegments(r,t),r.position.set(0,R,0),r.grid=2,r.visible=!1,q.add(r),t=new e.LineSegments(r.geometry,t),t.position.set(0,E,0),t.grid=4,t.visible=!1,q.add(t));w&&0<w.length&&(t=new e.LineDashedMaterial({color:0,dashSize:2,gapSize:2}),w=g.createLineSegments(w,t),w.position.set(b,0,0),w.grid=3,w.visible=!1,q.add(w),t=new e.LineSegments(w.geometry,t),t.position.set(d,
0,0),t.grid=1,t.visible=!1,q.add(t));var G=[];a=g.createLineSegments(a,k);for(t={$jscomp$loop$prop$n$66:0};4>t.$jscomp$loop$prop$n$66;t={$jscomp$loop$prop$n$66:t.$jscomp$loop$prop$n$66},++t.$jscomp$loop$prop$n$66)G.push(new e.Object3D),f.forEach(function(a){return function(c){var b=new e.Matrix4;b.set(-x,0,0,2*h,0,0,1,0,0,x,0,c.grz);c=new e.Mesh(c,y);c.applyMatrix4(b);G[a.$jscomp$loop$prop$n$66].add(c)}}(t)),l&&l.fTitle&&(w=new e.TextGeometry(M.translateLaTeX(l.fTitle),{font:JSROOT.threejs_font_helvetiker_regular,
size:p,height:0,curveSegments:5}),w.computeBoundingBox(),r=w.boundingBox.max.x-w.boundingBox.min.x,A=l.TestBit(JSROOT.EAxisBits.kCenterTitle)?(u+m-r)/2:u-r,w.rotateZ(Math.PI/2),r=new e.Matrix4,r.set(-x,0,0,3*h+v,0,0,1,0,0,x,0,A),w=new e.Mesh(w,y),w.applyMatrix4(r),G[t.$jscomp$loop$prop$n$66].add(w)),G[t.$jscomp$loop$prop$n$66].add(0==t.$jscomp$loop$prop$n$66?a:new e.LineSegments(a.geometry,k)),c.zoom&&G[t.$jscomp$loop$prop$n$66].add(z("z",this.size_z3d,c.use_y_for_z)),G[t.$jscomp$loop$prop$n$66].zid=
t.$jscomp$loop$prop$n$66+2,q.add(G[t.$jscomp$loop$prop$n$66]);G[0].position.set(d,R,0);G[0].rotation.z=.75*Math.PI;G[1].position.set(b,R,0);G[1].rotation.z=.25*Math.PI;G[2].position.set(b,E,0);G[2].rotation.z=-.25*Math.PI;G[3].position.set(d,E,0);G[3].rotation.z=-.75*Math.PI;if(0!==this.size_z3d){c=g.createLineSegments([d,0,0,b,0,0],k,null,!0);for(p=0;2>p;++p)f=new e.LineSegments(c,k),f.position.set(0,E,0===p?m:u),f.xyboxid=2,f.bottom=0==p,q.add(f),f=new e.LineSegments(c,k),f.position.set(0,R,0===
p?m:u),f.xyboxid=4,f.bottom=0==p,q.add(f);E=g.createLineSegments([0,E,0,0,R,0],k,null,!0);for(c=0;2>c;++c)p=new e.LineSegments(E,k),p.position.set(d,0,0===c?m:u),p.xyboxid=3,p.bottom=0==c,q.add(p),p=new e.LineSegments(E,k),p.position.set(b,0,0===c?m:u),p.xyboxid=1,p.bottom=0==c,q.add(p);d=g.createLineSegments([0,0,m,0,0,u],k,null,!0);for(m=0;4>m;++m)u=new e.LineSegments(d,k),u.zboxid=G[m].zid,u.position.copy(G[m].position),q.add(u)}};JSROOT.THistPainter.prototype.draw3DBins=function(){var a=this;
if(this.draw_content){if(this.isTH2Poly()&&this.drawPolyLego)return this.drawPolyLego();if(2==this.getDimension()&&this.options.Contour&&this.drawContour3D)return this.drawContour3D(!0);if(2==this.getDimension()&&this.options.Surf&&this.drawSurf)return this.drawSurf();if(2==this.getDimension()&&this.options.Error&&this.drawError)return this.drawError();var c=g.Box3D.Vertices,d=g.Box3D.Indexes,b=g.Box3D.Normals,E=g.Box3D.Segments,R=[0,1,1,2,2,3,3,0],m=[new e.Vector3(0,0,0),new e.Vector3(0,1,0),new e.Vector3(1,
1,0),new e.Vector3(1,0,0)],u=this.getFramePainter(),p=u.z_handle.getScaleMin(),k=u.z_handle.getScaleMax(),q=this.prepareColorDraw({rounding:!1,use3d:!0,extra:1}),f=q.i1,z=q.i2,t=q.j1,l=q.j2,v=this.getHisto(),w=v?v.$baseh:null,r=11===this.options.Lego||13===this.options.Lego,y=65535>v.getBin(z,l);if(!(f>=z||t>=l)){var h,x,B,A,I,Z,J=function(c,b,d){I=v.getBinContent(c+1,b+1);A=w?w.getBinContent(c+1,b+1):!1!==a.options.BaseLine?a.options.BaseLine:a.options.Zero?p:0;I<A&&(c=A,A=I,I=c);if(A>=G||I<C)return!1;
Z=I===C||A>=I;return!Z||0<d?!0:w?!1:a.options.Zero||0<p?!0:a._show_empty_bins},D=[p,k],H=null;if(12===this.options.Lego||14===this.options.Lego)D=this.createContour(v.fContour?v.fContour.length:20,u.lego_zmin,u.lego_zmax).arr,H=this.getHistPalette();for(var F=0;F<D.length-1;++F){var C=D[F];var G=D[F+1];H&&F==D.length-2&&G<k&&(G=k);var K=0,L=0,N=B=0,M=u.grz(C),O=u.grz(G);for(h=f;h<z;++h)for(x=t;x<l;++x)if(J(h,x,F)){var T=!Z&&0<F;var W=!Z&&I>G&&F<D.length-2;B+=Z?12:d.length;T&&(B-=6);W&&(B-=6);r&&!Z&&
(B-=12,N+=12)}var aa=new Float32Array(3*B),X=new Float32Array(3*B),S=y?new Uint16Array(B/3):new Uint32Array(B/3);var Q=0===N?null:new Float32Array(3*N);var U=0===N?null:new Float32Array(3*N),P=0===N?null:y?new Uint16Array(N/3):new Uint32Array(N/3),V=0,ea=0,fa=T=void 0,ca=void 0;for(h=f;h<z;++h){B=q.grx[h]+q.xbar1*(q.grx[h+1]-q.grx[h]);var Y=q.grx[h]+q.xbar2*(q.grx[h+1]-q.grx[h]);for(x=t;x<l;++x)if(J(h,x,F)){T=!Z&&0<F;W=!Z&&I>G&&F<D.length-2;var ha=q.gry[x]+q.ybar1*(q.gry[x+1]-q.gry[x]);var ka=q.gry[x]+
q.ybar2*(q.gry[x+1]-q.gry[x]);K=A<=C?M:u.grz(A);L=I>G?O:u.grz(I);fa=ca=0;Z&&(ca+=12,fa+=24);var la=d.length,ma=v.getBin(h+1,x+1);for(T&&(la-=6);fa<la;)T=c[d[fa]],r&&12>fa?(Q[ea]=B+T.x*(Y-B),Q[ea+1]=ha+T.y*(ka-ha),Q[ea+2]=K+T.z*(L-K),U[ea]=b[ca],U[ea+1]=b[ca+1],U[ea+2]=b[ca+2],0===ea%9&&(P[ea/9]=ma),ea+=3):(aa[V]=B+T.x*(Y-B),aa[V+1]=ha+T.y*(ka-ha),aa[V+2]=K+T.z*(L-K),X[V]=b[ca],X[V+1]=b[ca+1],X[V+2]=b[ca+2],0===V%9&&(S[V/9]=ma),V+=3),++fa,0===fa%6&&(ca+=3,W&&fa===d.length-12&&(fa+=6,ca+=3))}}h=new e.BufferGeometry;
h.setAttribute("position",new e.BufferAttribute(aa,3));h.setAttribute("normal",new e.BufferAttribute(X,3));x=v.fFillColor;B=this.getColor(x);if(H)B=H.calcColor(F,D.length);else if(1===this.options.Lego||2>x)x=1,B="white";Y=new e.MeshBasicMaterial({color:B});h=new e.Mesh(h,Y);h.face_to_bins_index=S;h.painter=this;h.zmin=p;h.zmax=k;h.baseline=!1!==this.options.BaseLine?this.options.BaseLine:this.options.Zero?p:0;h.tip_color=3===x?16711680:65280;h.handle=q;h.tooltip=function(a){if(!Number.isInteger(a.faceIndex))return console.error("faceIndex not provided, three.js version "+
e.REVISION+", expected 127"),null;if(0>a.faceIndex||a.faceIndex>=this.face_to_bins_index.length)return null;var c=this.painter,b=this.handle,d=c.getFramePainter(),f=c.getHisto();a=c.get3DToolTip(this.face_to_bins_index[a.faceIndex]);a.x1=Math.max(-d.size_x3d,b.grx[a.ix-1]+b.xbar1*(b.grx[a.ix]-b.grx[a.ix-1]));a.x2=Math.min(d.size_x3d,b.grx[a.ix-1]+b.xbar2*(b.grx[a.ix]-b.grx[a.ix-1]));a.y1=Math.max(-d.size_y3d,b.gry[a.iy-1]+b.ybar1*(b.gry[a.iy]-b.gry[a.iy-1]));a.y2=Math.min(d.size_y3d,b.gry[a.iy-1]+
b.ybar2*(b.gry[a.iy]-b.gry[a.iy-1]));b=this.baseline;var k=a.value;f.$baseh&&(b=f.$baseh.getBinContent(a.ix,a.iy));k<b&&(f=b,b=k,k=f);a.z1=d.grz(Math.max(this.zmin,b));a.z2=d.grz(Math.min(this.zmax,k));a.color=this.tip_color;c.is_projection&&2==c.getDimension()&&(a.$painter=c);return a};u.toplevel.add(h);0<N&&(Y=new e.BufferGeometry,Y.setAttribute("position",new e.BufferAttribute(Q,3)),Y.setAttribute("normal",new e.BufferAttribute(U,3)),x=2>x?new e.Color(16711680):new e.Color(n.rgb(B).darker(.5).toString()),
x=new e.MeshBasicMaterial({color:x}),x=new e.Mesh(Y,x),x.face_to_bins_index=P,x.painter=this,x.handle=h.handle,x.tooltip=h.tooltip,x.zmin=h.zmin,x.zmax=h.zmax,x.baseline=h.baseline,x.tip_color=h.tip_color,u.toplevel.add(x))}if(!(12<this.options.Lego)){B=Y=0;G=k;C=p;for(h=f;h<z;++h)for(x=t;x<l;++x)J(h,x,0)&&(Y+=Z?m.length:c.length,B+=Z?R.length:E.length);(d=65520>=Y)||(Y=3*B);b=new Float32Array(3*Y);r=d?new Uint16Array(B):null;y=u.grz(p);D=u.grz(k);N=P=F=H=0;for(h=f;h<z;++h)for(B=q.grx[h]+q.xbar1*
(q.grx[h+1]-q.grx[h]),Y=q.grx[h]+q.xbar2*(q.grx[h+1]-q.grx[h]),x=t;x<l;++x)if(J(h,x,0))if(ha=q.gry[x]+q.ybar1*(q.gry[x+1]-q.gry[x]),ka=q.gry[x]+q.ybar2*(q.gry[x+1]-q.gry[x]),H=A<=p?y:u.grz(A),F=I>k?D:u.grz(I),U=Z?R:E,S=Z?m:c,d){for(f=0;f<U.length;++f)r[N++]=P/3+U[f];for(f=0;f<S.length;++f)Q=S[f],b[P]=B+Q.x*(Y-B),b[P+1]=ha+Q.y*(ka-ha),b[P+2]=H+Q.z*(F-H),P+=3}else for(f=0;f<U.length;++f)Q=S[U[f]],b[P]=B+Q.x*(Y-B),b[P+1]=ha+Q.y*(ka-ha),b[P+2]=H+Q.z*(F-H),P+=3;c=this.getColor(v.fLineColor);c=new e.LineBasicMaterial({color:new e.Color(c),
linewidth:v.fLineWidth});c=g.createLineSegments(b,c,d?r:null);u.toplevel.add(c)}}}};g.drawAxis3D=function(a,c){a=new JSROOT.ObjectPainter(a,c);"_main"in c||a.addToPadPrimitives();a.Draw3DAxis=function(){var a=this.getFramePainter();if(!a||!a._toplevel)return Promise.reject(Error("no 3D frame found for 3D axis drawing"));var b=(new e.Box3).setFromObject(a._toplevel);this.xmin=b.min.x;this.xmax=b.max.x;this.ymin=b.min.y;this.ymax=b.max.y;this.zmin=b.min.z;this.zmax=b.max.z;this.size_x3d=this.size_y3d=
this.size_z3d=0;this.drawXYZ=JSROOT.TFramePainter.prototype.drawXYZ;this.drawXYZ(a._toplevel);a.adjustCameraPosition();a.render3D();return Promise.resolve(this)};return a.Draw3DAxis()};JSROOT.TH1Painter.prototype.draw3D=function(a){var c=this;this.mode3d=!0;var d=this.getFramePainter(),b=this.isMainPainter(),e=this.getHisto();"resize"==a?b&&d.resize3D()&&d.render3D():(this.deleteAttr(),this.scanContent(!0),b&&(d.create3DScene(this.options.Render3D,this.options.x3dscale,this.options.y3dscale),d.setAxesRanges(e.fXaxis,
this.xmin,this.xmax,e.fYaxis,this.ymin,this.ymax,e.fZaxis,0,0),d.set3DOptions(this.options),d.drawXYZ(d.toplevel,{use_y_for_z:!0,zmult:1.1,zoom:JSROOT.settings.Zooming,ndim:1})),d.mode3d&&(this.draw3DBins(),d.render3D(),this.updateStatWebCanvas(),d.addKeysHandler()));return b?this.drawColorPalette(this.options.Zscale&&(12===this.options.Lego||14===this.options.Lego)).then(function(){return c.drawHistTitle()}):Promise.resolve(this)};JSROOT.TH2Painter.prototype.draw3D=function(a){var c=this;this.mode3d=
!0;var d=this.getFramePainter(),b=this.isMainPainter(),e=this.getHisto();if("resize"==a)b&&d.resize3D()&&d.render3D();else{a=this.getPadPainter().getRootPad(!0);var g=1.1;this.zmin=a&&a.fLogz?.3*this.gminposbin:this.gminbin;this.zmax=this.gmaxbin;-1111!==this.options.minimum&&(this.zmin=this.options.minimum);-1111!==this.options.maximum&&(this.zmax=this.options.maximum,g=1);a&&a.fLogz&&0>=this.zmin&&(this.zmin=1E-5*this.zmax);this.deleteAttr();b&&(d.create3DScene(this.options.Render3D,this.options.x3dscale,
this.options.y3dscale),d.setAxesRanges(e.fXaxis,this.xmin,this.xmax,e.fYaxis,this.ymin,this.ymax,e.fZaxis,this.zmin,this.zmax),d.set3DOptions(this.options),d.drawXYZ(d.toplevel,{zmult:g,zoom:JSROOT.settings.Zooming,ndim:2}));d.mode3d&&(this.draw3DBins(),d.render3D(),this.updateStatWebCanvas(),d.addKeysHandler())}return b?this.drawColorPalette(this.options.Zscale&&(12===this.options.Lego||14===this.options.Lego||11===this.options.Surf||12===this.options.Surf)).then(function(){return c.drawHistTitle()}):
Promise.resolve(this)};JSROOT.TH2Painter.prototype.drawContour3D=function(a){var c=this.getFramePainter(),d=this.prepareColorDraw({rounding:!1,use3d:!0,extra:100,middle:0}),b=this.getHisto(),e=this.getContourLevels(),R=this.getHistPalette(),m=2*c.size_z3d,u=[];this.buildContour(d,e,R,function(b,d,q,f,g,E){if(!(3>g-f)){if(a&&(m=c.grz(e[E]),0>m||m>2*c.size_z3d))return;for(b=f;b<g;++b)u.push(d[b],q[b],m),u.push(d[b+1],q[b+1],m)}});d=g.createLineSegments(u,g.create3DLineMaterial(this,b));c.toplevel.add(d)};
JSROOT.TH2Painter.prototype.drawSurf=function(){function a(a,b,c,d,e,f){if(w){var k=0>c?-1:c>2*u.size_z3d?1:0,h=0>f?-1:f>2*u.size_z3d?1:0;if(k!==h||0===k){if(!x)return++C;if(0!==k){var q=f-c;c=0>k?0:2*u.size_z3d;a=d-(d-a)/q*(f-c);b=e-(e-b)/q*(f-c)}0!==h&&(k=c-f,f=0>h?0:2*u.size_z3d,d=a-(a-d)/k*(c-f),e=b-(b-e)/k*(c-f));J[D]=a;J[D+1]=b;J[D+2]=c;D+=3;J[D]=d;J[D+1]=e;J[D+2]=f;D+=3}}}function c(a,b,c,d,e,f,k,h){L>=K.length&&console.log("more than 6 points???");c=(k-c)/(f-c);f=3;0!==N&&Math.abs(c)<Math.abs(N)&&
(K[L]=K[L-3],K[L+1]=K[L-2],K[L+2]=K[L-1],L-=3,f=6);K[L]=a+c*(d-a);K[L+1]=b+c*(e-b);K[L+2]=k;h&&F&&(O[ba]=K[L],O[ba+1]=K[L+1],O[ba+2]=K[L+2],ba+=3);L+=f;N=c}function d(a,b,c){b=8*((b-p.i1)*(p.j2-p.j1)+(c-p.j1));if(0<=G[b])return console.error("More than 8 vertexes for the bin");c=b+8+G[b];G[b]--;G[c]=a}function b(a){for(var b=p.i1;b<p.i2;++b)for(var c=p.j1;c<p.j2;++c){var d=8*((b-p.i1)*(p.j2-p.j1)+(c-p.j1));if(-1!==G[d]){var e=0<=G[d]?d:d+9+G[d];d+=8;for(var f=0,k=0,h=0,q=e;q<d;++q){var g=G[q];if(0>
g)return console.error("FAILURE in NORMALS RECALCULATIONS");f+=a[g];k+=a[g+1];h+=a[g+2]}f/=d-e;k/=d-e;for(h/=d-e;e<d;++e)q=G[e],a[q]=f,a[q+1]=k,a[q+2]=h}}}function E(a,b,e,f,h,g,p,E,r,u){for(var m=1;m<v.length;++m){var l=e<v[m-1]?-1:e>v[m]?1:0,t=g<v[m-1]?-1:g>v[m]?1:0,w=r<v[m-1]?-1:r>v[m]?1:0,z=l+t+w;if(3!==z){if(-3===z)break;if(x){if(L=ba=0,0===l&&(K[L]=a,K[L+1]=b,K[L+2]=e,L+=3),l!==t&&(N=0,(0>l||0>t)&&c(a,b,e,f,h,g,v[m-1]),(0<l||0<t)&&c(a,b,e,f,h,g,v[m],!0)),0===t&&(K[L]=f,K[L+1]=h,K[L+2]=g,L+=
3),t!==w&&(N=0,(0>t||0>w)&&c(f,h,g,p,E,r,v[m-1]),(0<t||0<w)&&c(f,h,g,p,E,r,v[m],!0)),0===w&&(K[L]=p,K[L+1]=E,K[L+2]=r,L+=3),w!==l&&(N=0,(0>w||0>l)&&c(p,E,r,a,b,e,v[m-1]),(0<w||0<l)&&c(p,E,r,a,b,e,v[m],!0)),0!==L)if(9>L)console.log("found less than 3 points",L/3);else{if(F&&6===ba){for(l=0;6>l;++l)F[M+l]=O[l];M+=6}l=A[m];t=n[m];y&&9===L&&(d(t,k,q),d(t+3,k+1,u?q+1:q),d(t+6,u?k:k+1,q+1));for(w=3;w<L-3;w+=3)l[t]=K[0],l[t+1]=K[1],l[t+2]=K[2],t+=3,l[t]=K[w],l[t+1]=K[w+1],l[t+2]=K[w+2],t+=3,l[t]=K[w+3],
l[t+1]=K[w+4],l[t+2]=K[w+5],t+=3;n[m]=t}}else z=Math.abs(t-l)+Math.abs(w-t)+Math.abs(l-w),0===l&&++z,0===t&&++z,0===w&&++z,1!==z&&2!==z||console.error("FOND npnts",z),2<z&&(void 0===B[m]&&(B[m]=0),B[m]+=z-2),!(0<l||0<t||0<w)||l===t&&t===w&&w===l||++H}}}var R=this,m=this.getHisto(),u=this.getFramePainter(),p=this.prepareColorDraw({rounding:!1,use3d:!0,extra:1,middle:.5}),k,q,f,z,t=u.z_handle.getScaleMin(),l=u.logz?function(a){return a<t?-.1:u.grz(a)}:u.grz;if(!(2>p.i2-p.i1||2>p.j2-p.j1)){var v=f=null,
w=!0,r=!1,y=!1,h=null;switch(this.options.Surf){case 11:f=this.getContourLevels();h=this.getHistPalette();break;case 12:case 15:case 17:f=this.getContourLevels();h=this.getHistPalette();w=!1;break;case 14:w=!1;y=!0;break;case 16:f=this.getContourLevels();r=!0;w=!1;break;default:f=u.z_handle.createTicks(!0),r=!0}if(f)for(v=new Float32Array(f.length),z=0;z<f.length;++z)v[z]=l(f[z]);else v=[0,2*u.size_z3d];var x,B=[],A=[],n=[],C=0,J=null,D=0,H=0,F=null,M=0,G=[],K=new Float32Array(18),L=0,N=0,O=new Float32Array(6),
ba=0;if(y)for(G=new Int32Array((p.i2-p.i1)*(p.j2-p.j1)*8),f=0;f<G.length;++f)G[f]=-1;for(x=0;2>x;++x){if(x){for(f=1;f<v.length;++f)B[f]&&(A[f]=new Float32Array(9*B[f]),n[f]=0);w&&0<C&&(J=new Float32Array(6*C));r&&0<H&&(F=new Float32Array(6*H))}for(k=p.i1;k<p.i2-1;++k){f=p.grx[k];var T=p.grx[k+1];for(q=p.j1;q<p.j2-1;++q){z=p.gry[q];var W=p.gry[q+1];var aa=l(m.getBinContent(k+1,q+1));var X=l(m.getBinContent(k+1,q+2));var S=l(m.getBinContent(k+2,q+1));var Q=l(m.getBinContent(k+2,q+2));E(f,z,aa,T,W,Q,
f,W,X,!0);E(f,z,aa,T,z,S,T,W,Q,!1);a(f,W,X,f,z,aa);a(f,z,aa,T,z,S);k===p.i2-2&&a(T,z,S,T,W,Q);q===p.j2-2&&a(f,W,X,T,W,Q)}}}for(l=1;l<v.length;++l)A[l]&&(n[l]!==9*B[l]&&console.error("SURF faces missmatch lvl",l,"faces",B[l],"index",n[l],"check",9*B[l]-n[l]),r=new e.BufferGeometry,r.setAttribute("position",new e.BufferAttribute(A[l],3)),r.computeVertexNormals(),y&&1===l&&b(r.getAttribute("normal").array),f=f=void 0,h?f=h.calcColor(l,v.length):(f=1<m.fFillColor?this.getColor(m.fFillColor):"white",14===
this.options.Surf&&2>m.fFillColor&&(f=this.getColor(48))),f=14===this.options.Surf?new e.MeshLambertMaterial({color:f,side:e.DoubleSide}):new e.MeshBasicMaterial({color:f,side:e.DoubleSide}),r=new e.Mesh(r,f),u.toplevel.add(r),r.painter=this);J&&(6*C!==D&&console.error("SURF lines mismmatch nsegm",C," lindx",D,"difference",6*C-D),h=this.getColor(m.fLineColor),h=new e.LineBasicMaterial({color:new e.Color(h),linewidth:m.fLineWidth}),h=g.createLineSegments(J,h),h.painter=this,u.toplevel.add(h));F&&(6*
H!==M&&console.error("SURF grid draw mismatch ngridsegm",H,"gindx",M,"diff",6*H-M),m=1===this.options.Surf?new e.LineDashedMaterial({color:0,dashSize:2,gapSize:2}):new e.LineBasicMaterial({color:new e.Color(this.getColor(m.fLineColor))}),m=g.createLineSegments(F,m),m.painter=this,u.toplevel.add(m));17===this.options.Surf&&this.drawContour3D();if(13===this.options.Surf){p=this.prepareColorDraw({rounding:!1,use3d:!0,extra:100,middle:0});m=this.getContourLevels();var U=this.getHistPalette(),P=-1,V=2*
u.size_z3d;this.buildContour(p,m,U,function(a,b,c,d,f){b[f]===b[d]&&c[f]===c[d]&&f--;if(!(3>f-d)){for(var k=[],h=d;h<=f;++h)h!==d&&b[h]===b[h-1]&&c[h]===c[h-1]||k.push(new e.Vector2(b[h],c[h]));if(!(3>k.length)&&(d=e.ShapeUtils.triangulateShape(k,[]))&&0!==d.length){if(0>P||P!==a)P=a,V+=1E-4*u.size_z3d;b=new Float32Array(9*d.length);c=new Float32Array(9*d.length);for(h=f=0;h<d.length;++h)for(var l=d[h],q=0;3>q;++q){var m=k[l[q]];b[f]=m.x;b[f+1]=m.y;b[f+2]=V;c[f]=0;c[f+1]=0;c[f+2]=1;f+=3}k=new e.BufferGeometry;
k.setAttribute("position",new e.BufferAttribute(b,3));k.setAttribute("normal",new e.BufferAttribute(c,3));a=U.getColor(a);a=new e.MeshBasicMaterial({color:a,side:e.DoubleSide,opacity:.5});a=new e.Mesh(k,a);a.painter=R;u.toplevel.add(a)}}})}}};JSROOT.TH2Painter.prototype.drawError=function(){for(var a=this.getFramePainter(),c=this.getHisto(),d=this.prepareColorDraw({rounding:!1,use3d:!0,extra:1}),b=a.z_handle.getScaleMin(),E=a.z_handle.getScaleMax(),n,m,u,p,k,q,f,z,t,l=0,v=null,w=null,r=0,y=0;2>y;++y){for(n=
d.i1;n<d.i2;++n)for(q=d.grx[n],f=d.grx[n+1],m=d.j1;m<d.j2;++m)if(p=c.getBinContent(n+1,m+1),!(p<b||p>E)){if(k=p===b)k=this.options.Zero||0<b?!1:!this._show_empty_bins;k||(0===y?l+=3:(u=c.getBin(n+1,m+1),k=c.getBinError(u),w[r/18]=u,u=d.gry[m],z=d.gry[m+1],t=a.grz(p-k<b?b:p-k),p=a.grz(p+k>E?E:p+k),v[r]=q,v[r+3]=f,v[r+1]=v[r+4]=(u+z)/2,v[r+2]=v[r+5]=(t+p)/2,r+=6,v[r]=v[r+3]=(q+f)/2,v[r+1]=u,v[r+4]=z,v[r+2]=v[r+5]=(t+p)/2,r+=6,v[r]=v[r+3]=(q+f)/2,v[r+1]=v[r+4]=(u+z)/2,v[r+2]=t,v[r+5]=p,r+=6))}if(0===
y){if(0===l)return;v=new Float32Array(6*l);w=new Int32Array(l/3)}}c=this.getColor(this.getObject().fLineColor);c=new e.LineBasicMaterial({color:new e.Color(c),linewidth:this.getObject().fLineWidth});v=g.createLineSegments(v,c);v.painter=this;v.intersect_index=w;v.zmin=b;v.zmax=E;v.tip_color=3===this.getObject().fLineColor?16711680:65280;v.tooltip=function(a){if(!Number.isInteger(a.index))return console.error("segment index not provided, three.js version "+e.REVISION+", expected 127"),null;var b=Math.floor(a.index/
6);if(0>b||b>=this.intersect_index.length)return null;var c=this.painter;a=c.getHisto();var d=c.getFramePainter();b=c.get3DToolTip(this.intersect_index[b]);b.x1=Math.max(-d.size_x3d,d.grx(a.fXaxis.GetBinLowEdge(b.ix)));b.x2=Math.min(d.size_x3d,d.grx(a.fXaxis.GetBinLowEdge(b.ix+1)));b.y1=Math.max(-d.size_y3d,d.gry(a.fYaxis.GetBinLowEdge(b.iy)));b.y2=Math.min(d.size_y3d,d.gry(a.fYaxis.GetBinLowEdge(b.iy+1)));b.z1=d.grz(b.value-b.error<this.zmin?this.zmin:b.value-b.error);b.z2=d.grz(b.value+b.error>
this.zmax?this.zmax:b.value+b.error);b.color=this.tip_color;return b};a.toplevel.add(v)};JSROOT.TH2Painter.prototype.drawPolyLego=function(){var a=this.getHisto(),c=this.getFramePainter(),d=c.z_handle.getScaleMin(),b=c.z_handle.getScaleMax(),g,n=a.fBins.arr.length,m=c.grz(d);this.maxbin=this.gmaxbin;this.minbin=this.gminbin;this.minposbin=this.gminposbin;var u=this.getContour(!0),p=this.getHistPalette();for(g=0;g<n;++g){var k=a.fBins.arr[g];if(!(k.fContent<d)){var q=u.getPaletteIndex(p,k.fContent);
if(null!==q&&!(k.fXmin>c.scale_xmax||k.fXmax<c.scale_xmin||k.fYmin>c.scale_ymax||k.fYmax<c.scale_ymin)){var f=c.grz(k.fContent>b?b:k.fContent);var z=[],t=[],l=1,v=k.fPoly,w=0;"TMultiGraph"==v._typename&&(l=k.fPoly.fGraphs.arr.length,v=null);for(var r=0;r<l;++r){if(!v||0<r)v=k.fPoly.fGraphs.arr[r];for(var y=v.fNpoints,h=v.fX,x=v.fY;2<y&&h[0]===h[y-1]&&x[0]===x[y-1];)--y;for(var B=void 0,A=void 0,I=0;2>I;++I){var C=void 0,J=void 0,D=void 0,H=void 0,F=c.size_x3d*c.size_z3d,M=0<I?0:F/1E6;B=[];A=null;
for(var G=0;G<y;++G)D=c.grx(h[G]),H=c.gry(x[G]),0<G&&(F=(D-C)*(D-C)+(H-J)*(H-J)),F>M&&(B.push(new e.Vector2(D,H)),C=D,J=H);try{2<B.length&&(A=e.ShapeUtils.triangulateShape(B,[]))}catch(K){A=null}if(A&&A.length>B.length-3)break}A&&A.length&&B&&(z.push(B),t.push(A),w+=2*A.length,f>m&&(w+=2*B.length))}k=new Float32Array(9*w);for(v=l=0;v<z.length;++v){w=z[v];r=t[v];for(y=0;2>y;++y)for(h=0;h<r.length;++h)A=r[h],x=w[A[0]],B=w[A[0===y?2:1]],A=w[A[0===y?1:2]],k[l]=x.x,k[l+1]=x.y,k[l+2]=y?f:m,l+=3,k[l]=B.x,
k[l+1]=B.y,k[l+2]=y?f:m,l+=3,k[l]=A.x,k[l+1]=A.y,k[l+2]=y?f:m,l+=3;if(f>m)for(r=0;r<w.length;++r)y=w[r],h=w[0<r?r-1:w.length-1],k[l]=y.x,k[l+1]=y.y,k[l+2]=m,l+=3,k[l]=h.x,k[l+1]=h.y,k[l+2]=m,l+=3,k[l]=h.x,k[l+1]=h.y,k[l+2]=f,l+=3,k[l]=y.x,k[l+1]=y.y,k[l+2]=m,l+=3,k[l]=h.x,k[l+1]=h.y,k[l+2]=f,l+=3,k[l]=y.x,k[l+1]=y.y,k[l+2]=f,l+=3}z=new e.BufferGeometry;z.setAttribute("position",new e.BufferAttribute(k,3));z.computeVertexNormals();q=this.fPalette.getColor(q);q=new e.MeshBasicMaterial({color:q});q=
new e.Mesh(z,q);c.toplevel.add(q);q.painter=this;q.bins_index=g;q.draw_z0=m;q.draw_z1=f;q.tip_color=65280;q.tooltip=function(){var a=this.painter,b=a.getFramePainter(),c=a.getObject().fBins.arr[this.bins_index];return{use_itself:!0,x1:b.grx(c.fXmin),x2:b.grx(c.fXmax),y1:b.gry(c.fYmin),y2:b.gry(c.fYmax),z1:this.draw_z0,z2:this.draw_z1,bin:this.bins_index,value:c.fContent,color:this.tip_color,lines:a.getPolyBinTooltips(this.bins_index)}}}}}};O.prototype=Object.create(JSROOT.THistPainter.prototype);
O.prototype.scanContent=function(a){if(!(a&&this.nbinsx&&this.nbinsy&&this.nbinsz)){a=this.getObject();this.extractAxesProperties(3);this.gminbin=this.gmaxbin=a.getBinContent(1,1,1);for(var c=0;c<this.nbinsx;++c)for(var d=0;d<this.nbinsy;++d)for(var b=0;b<this.nbinsz;++b){var e=a.getBinContent(c+1,d+1,b+1);e<this.gminbin?this.gminbin=e:e>this.gmaxbin&&(this.gmaxbin=e)}this.draw_content=0<this.gmaxbin}};O.prototype.countStat=function(){var a=this.getHisto(),c=a.fXaxis,d=a.fYaxis,b=a.fZaxis,e=0,g=0,
m=0,u=0,p=0,k=0,q=0,f=this.getSelectIndex("x","left"),z=this.getSelectIndex("x","right"),t=this.getSelectIndex("y","left"),l=this.getSelectIndex("y","right"),v=this.getSelectIndex("z","left"),w=this.getSelectIndex("z","right"),r=this.getFramePainter(),y={name:a.fName,entries:0,integral:0,meanx:0,meany:0,meanz:0,rmsx:0,rmsy:0,rmsz:0},h,x,n;for(h=0;h<this.nbinsx+2;++h){var A=c.GetBinCoord(h-.5);var I=h<f?0:h>z?2:1;for(x=0;x<this.nbinsy+2;++x){var C=d.GetBinCoord(x-.5);var J=x<t?0:x>l?2:1;for(n=0;n<
this.nbinsz+2;++n){var D=b.GetBinCoord(n-.5);var H=n<v?0:n>w?2:1;var F=a.getBinContent(h,x,n);y.entries+=F;1==I&&1==J&&1==H&&(e+=F,g+=A*F,m+=C*F,u+=D*F,p+=A*A*F,k+=C*C*F,q+=D*D*F)}}}0<a.fTsumw&&!r.isAxisZoomed("x")&&!r.isAxisZoomed("y")&&!r.isAxisZoomed("z")&&(e=a.fTsumw,g=a.fTsumwx,p=a.fTsumwx2,m=a.fTsumwy,k=a.fTsumwy2,u=a.fTsumwz,q=a.fTsumwz2);0<e&&(y.meanx=g/e,y.meany=m/e,y.meanz=u/e,y.rmsx=Math.sqrt(Math.abs(p/e-y.meanx*y.meanx)),y.rmsy=Math.sqrt(Math.abs(k/e-y.meany*y.meany)),y.rmsz=Math.sqrt(Math.abs(q/
e-y.meanz*y.meanz)));y.integral=e;1<a.fEntries&&(y.entries=a.fEntries);return y};O.prototype.fillStatistic=function(a,c,d){if(this.isIgnoreStatsFill())return!1;var b=this.countStat(),e=c%10,g=Math.floor(c/10)%10,m=Math.floor(c/100)%10,u=Math.floor(c/1E3)%10;c=Math.floor(c/1E6)%10;a.clearPave();0<e&&a.addText(b.name);0<g&&a.addText("Entries = "+a.format(b.entries,"entries"));0<m&&(a.addText("Mean x = "+a.format(b.meanx)),a.addText("Mean y = "+a.format(b.meany)),a.addText("Mean z = "+a.format(b.meanz)));
0<u&&(a.addText("Std Dev x = "+a.format(b.rmsx)),a.addText("Std Dev y = "+a.format(b.rmsy)),a.addText("Std Dev z = "+a.format(b.rmsz)));0<c&&a.addText("Integral = "+a.format(b.integral,"entries"));d&&a.fillFunctionStat(this.findFunction("TF3"),d);return!0};O.prototype.getBinTooltips=function(a,c,d){var b=[],e=this.getHisto();b.push(this.getObjectHint());b.push("x = "+this.getAxisBinTip("x",e.fXaxis,a)+"  xbin="+(a+1));b.push("y = "+this.getAxisBinTip("y",e.fYaxis,c)+"  ybin="+(c+1));b.push("z = "+
this.getAxisBinTip("z",e.fZaxis,d)+"  zbin="+(d+1));a=e.getBinContent(a+1,c+1,d+1);a===Math.round(a)?b.push("entries = "+a):b.push("entries = "+g.floatToString(a,JSROOT.gStyle.fStatFormat));return b};O.prototype.draw3DScatter=function(){var a=this,c=this.getObject(),d=this.getFramePainter(),b=this.getSelectIndex("x","left",.5),E=this.getSelectIndex("x","right",0),n=this.getSelectIndex("y","left",.5),m=this.getSelectIndex("y","right",0),u=this.getSelectIndex("z","left",.5),p=this.getSelectIndex("z",
"right",0),k,q,f;if(E<=b||m<=n||p<=u)return Promise.resolve(!0);var z=1E3<this.gmaxbin?1E3/this.gmaxbin:1,t=0,l=0,v=Math.max(0,this.gminbin);for(k=b;k<E;++k)for(q=n;q<m;++q)for(f=u;f<p;++f){var w=c.getBinContent(k+1,q+1,f+1);l+=w;w<=v||(t+=Math.round(w*z))}if(t>(d.webgl?1E5:3E4))return!1;JSROOT.seed(l);l=new g.PointsCreator(t,d.webgl,d.size_x3d/200);var r=new Int32Array(t);t=0;for(k=b;k<E;++k)for(q=n;q<m;++q)for(f=u;f<p;++f)if(w=c.getBinContent(k+1,q+1,f+1),!(w<=v))for(b=Math.round(w*z),w=0;w<b;++w){var y=
c.fXaxis.GetBinCoord(k+JSROOT.random()),h=c.fYaxis.GetBinCoord(q+JSROOT.random()),x=c.fZaxis.GetBinCoord(f+JSROOT.random());r[t++]=c.getBin(k+1,q+1,f+1);l.addPoint(d.grx(y),d.gry(h),d.grz(x))}return l.createPoints({color:this.getColor(c.fMarkerColor),promise:!0}).then(function(b){d.toplevel.add(b);b.bins=r;b.painter=a;b.tip_color=3===c.fMarkerColor?16711680:65280;b.tooltip=function(a){if(!Number.isInteger(a.index))return console.error("intersect.index not provided, three.js version "+e.REVISION+", expected 127"),
null;var b=Math.floor(a.index/this.nvertex);if(0>b||b>=this.bins.length)return null;var c=this.painter;a=c.getHisto();var d=c.getFramePainter();b=c.get3DToolTip(this.bins[b]);b.x1=d.grx(a.fXaxis.GetBinLowEdge(b.ix));b.x2=d.grx(a.fXaxis.GetBinLowEdge(b.ix+1));b.y1=d.gry(a.fYaxis.GetBinLowEdge(b.iy));b.y2=d.gry(a.fYaxis.GetBinLowEdge(b.iy+1));b.z1=d.grz(a.fZaxis.GetBinLowEdge(b.iz));b.z2=d.grz(a.fZaxis.GetBinLowEdge(b.iz+1));b.color=this.tip_color;b.opacity=.3;return b};return!0})};O.prototype.draw3DBins=
function(){this.draw_content||Promise.resolve(!1);if(!(this.options.Box||this.options.GLBox||this.options.GLColor||this.options.Lego)){var a=this.draw3DScatter();if(!1!==a)return a}a=this.getObject().fFillColor;var c=this.getColor(a),d=this.getFramePainter(),b=0,E=!1,n=!1,m=!1,u=1,p=!0,k=this.options.Box?this.options.BoxStyle:0,q=.5;!k&&this.options.Lego&&(k=1===this.options.Lego?10:this.options.Lego);if(11===this.options.GLBox||12===this.options.GLBox){q=.4;E=!0;12===this.options.GLBox&&(m=!0);b=
d.webgl?new e.SphereGeometry(.5,16,12):new e.SphereGeometry(.5,8,6);b.applyMatrix4((new e.Matrix4).makeRotationX(Math.PI/2));b.computeVertexNormals();k=b.getIndex().array;var f=b.getAttribute("position").array,z=b.getAttribute("normal").array;b=3*k.length;var t=new Float32Array(b);var l=new Float32Array(b);for(var v=0;v<k.length;++v){var w=3*k[v];t[3*v]=f[w];t[3*v+1]=f[w+1];t[3*v+2]=f[w+2];l[3*v]=z[w];l[3*v+1]=z[w+1];l[3*v+2]=z[w+2]}}else{f=g.Box3D.Indexes;z=g.Box3D.Normals;v=g.Box3D.Vertices;b=3*
f.length;t=new Float32Array(b);l=new Float32Array(b);w=0;for(var r=-3;w<f.length;++w){var y=v[f[w]];t[3*w]=y.x-.5;t[3*w+1]=y.y-.5;t[3*w+2]=y.z-.5;0===w%6&&(r+=3);l[3*w]=z[r];l[3*w+1]=z[r+1];l[3*w+2]=z[r+2]}n=!0;12===k?m=!0:13===k?(m=!0,n=!1):this.options.GLColor&&(m=!0,u=.5,n=p=!1,E=!0)}p&&(p=this.gminbin||this.gmaxbin?1/Math.max(Math.abs(this.gminbin),Math.abs(this.gmaxbin)):1);var h=this.getHisto(),x=this.getSelectIndex("x","left",.5),B=this.getSelectIndex("x","right",0),A=this.getSelectIndex("y",
"left",.5),C=this.getSelectIndex("y","right",0),M=this.getSelectIndex("z","left",.5),J=this.getSelectIndex("z","right",0);if(!(B<=x||C<=A||J<=M)){k=(d.grx(h.fXaxis.GetBinLowEdge(B+1))-d.grx(h.fXaxis.GetBinLowEdge(x+1)))/(B-x);f=(d.gry(h.fYaxis.GetBinLowEdge(C+1))-d.gry(h.fYaxis.GetBinLowEdge(A+1)))/(C-A);z=(d.grz(h.fZaxis.GetBinLowEdge(J+1))-d.grz(h.fZaxis.GetBinLowEdge(M+1)))/(J-M);var D=0,H,F,O;v=[];var G=0;w=[];var K=m?this.getContour():null,L=m?this.getHistPalette():null;for(H=x;H<B;++H)for(F=
A;F<C;++F)for(O=M;O<J;++O){var N=h.getBinContent(H+1,F+1,O+1);if(this.options.GLColor||!(0===N||N<this.gminbin)){var da=p?Math.pow(Math.abs(N*p),.3333):1;.001>da||(D++,m&&(r=K.getPaletteIndex(L,N),null!==r?(void 0===v[r]&&(v[r]=0,w[r]=G++),v[r]+=1):console.error("not found color for",N)))}}m||(v.push(D),G=1,w=[0]);var ba=Array(G);r=Array(G);y=Array(G);var T=Array(G),W=Array(G),aa=Array(G);G=Array(G);for(H=0;H<v.length;++H)v[H]&&(D=v[H],F=w[H],ba[F]=0,W[F]=0,n&&(W[F]=65520<D*b/3?2:1),r[F]=new Float32Array(D*
b),y[F]=new Float32Array(D*b),T[F]=new Int32Array(D),1===W[F]&&(aa[F]=new Uint16Array(D*g.Box3D.MeshSegments.length)),2===W[F]&&(G[F]=new Float32Array(D*g.Box3D.Segments.length*3)));for(H=x;H<B;++H)for(D=h.fXaxis.GetBinCenter(H+1),n=d.grx(D),F=A;F<C;++F)for(D=h.fYaxis.GetBinCenter(F+1),x=d.gry(D),O=M;O<J;++O)if(N=h.getBinContent(H+1,F+1,O+1),this.options.GLColor||!(0===N||N<this.gminbin))if(da=p?Math.pow(Math.abs(N*p),.3333):1,!(.001>da)){var X=0;if(m){D=K.getPaletteIndex(L,N);if(null===D)continue;
X=w[D]}D=ba[X];N=h.fZaxis.GetBinCenter(O+1);N=d.grz(N);T[X][D]=h.getBin(H+1,F+1,O+1);for(var S=D*b,Q=r[X],U=y[X],P=0;P<b;P+=3,S+=3)Q[S]=n+t[P]*k*da,Q[S+1]=x+t[P+1]*f*da,Q[S+2]=N+t[P+2]*z*da,U[S]=l[P],U[S+1]=l[P+1],U[S+2]=l[P+2];if(1===W[X]){Q=g.Box3D.MeshSegments;S=D*Q.length;U=Math.round(D*b/3);P=aa[X];for(var V=0;V<Q.length;++V)P[S+V]=U+Q[V]}if(2===W[X])for(Q=g.Box3D.Segments,U=G[X],S=D*Q.length*3,P=0;P<Q.length;++P,S+=3)V=g.Box3D.Vertices[Q[P]],U[S]=n+(V.x-.5)*k*da,U[S+1]=x+(V.y-.5)*f*da,U[S+2]=
N+(V.z-.5)*z*da;ba[X]=D+1}for(t=0;t<v.length;++t)v[t]&&(l=w[t],h=new e.BufferGeometry,h.setAttribute("position",new e.BufferAttribute(r[l],3)),h.setAttribute("normal",new e.BufferAttribute(y[l],3)),m&&(c=this.fPalette.getColor(t)),B=E?new e.MeshLambertMaterial({color:c,opacity:u,transparent:1>u}):new e.MeshBasicMaterial({color:c,opacity:u}),h=new e.Mesh(h,B),h.bins=T[l],h.bins_faces=b/9,h.painter=this,h.scalex=q*k,h.scaley=q*f,h.scalez=q*z,h.tip_color=3===a?16711680:65280,h.use_scale=p,h.tooltip=
function(a){if(!Number.isInteger(a.faceIndex))return console.error("intersect.faceIndex not provided, three.js version "+e.REVISION+", expected 127"),null;var b=Math.floor(a.faceIndex/this.bins_faces);if(0>b||b>=this.bins.length)return null;var c=this.painter;a=c.getHisto();var d=c.getFramePainter();b=c.get3DToolTip(this.bins[b]);c=d.grx(a.fXaxis.GetBinCoord(b.ix-.5));var f=d.gry(a.fYaxis.GetBinCoord(b.iy-.5));a=d.grz(a.fZaxis.GetBinCoord(b.iz-.5));d=this.use_scale?Math.pow(Math.abs(b.value*this.use_scale),
.3333):1;b.x1=c-this.scalex*d;b.x2=c+this.scalex*d;b.y1=f-this.scaley*d;b.y2=f+this.scaley*d;b.z1=a-this.scalez*d;b.z2=a+this.scalez*d;b.color=this.tip_color;return b},d.toplevel.add(h),0<W[l]&&(h=this.getColor(this.getObject().fLineColor),h=new e.LineBasicMaterial({color:h}),B=null,B=1===W[l]?g.createLineSegments(r[l],h,aa[l]):g.createLineSegments(G[l],h),d.toplevel.add(B)));return Promise.resolve(!0)}};O.prototype.redraw=function(a){var c=this,d=this.getFramePainter(),b=this.getHisto(),e=Promise.resolve(!0);
"resize"==a?d.resize3D()&&d.render3D():(d.create3DScene(this.options.Render3D,this.options.x3dscale,this.options.y3dscale),d.setAxesRanges(b.fXaxis,this.xmin,this.xmax,b.fYaxis,this.ymin,this.ymax,b.fZaxis,this.zmin,this.zmax),d.set3DOptions(this.options),d.drawXYZ(d.toplevel,{zoom:JSROOT.settings.Zooming,ndim:3}),e=this.draw3DBins().then(function(){d.render3D();c.updateStatWebCanvas();d.addKeysHandler()}));return e.then(function(){return c.drawHistTitle()})};O.prototype.fillToolbar=function(){var a=
this.getPadPainter();a&&(a.addPadButton("auto_zoom","Unzoom all axes","ToggleZoom","Ctrl *"),this.draw_content&&a.addPadButton("statbox","Toggle stat box","ToggleStatBox"),a.showPadButtons())};O.prototype.canZoomInside=function(a,c,d){var b=this.getHisto();b&&(b=b["f"+a.toUpperCase()+"axis"]);return!b||1<b.FindBin(d,.5)-b.FindBin(c,0)};O.prototype.autoZoom=function(){var a=this.getSelectIndex("x","left"),c=this.getSelectIndex("x","right"),d=this.getSelectIndex("y","left"),b=this.getSelectIndex("y",
"right"),e=this.getSelectIndex("z","left"),g=this.getSelectIndex("z","right"),m,u,p,k=this.getObject();if(a!==c&&d!==b&&e!==g){var q=k.getBinContent(a+1,d+1,e+1);for(m=a;m<c;++m)for(u=d;u<b;++u)for(p=e;p<g;++p)q=Math.min(q,k.getBinContent(m+1,u+1,p+1));if(!(0<q)){var f=c,n=a,t=b,l=d,v=g,w=e;for(m=a;m<c;++m)for(u=d;u<b;++u)for(p=e;p<g;++p)k.getBinContent(m+1,u+1,p+1)>q&&(m<f&&(f=m),m>=n&&(n=m+1),u<t&&(t=u),u>=l&&(l=u+1),p<v&&(v=p),p>=w&&(w=p+1));m=!1;f===n-1&&f>a+1&&n<c-1&&(f--,n++);t===l-1&&t>d+1&&
l<b-1&&(t--,l++);v===w-1&&v>e+1&&w<g-1&&(v--,w++);if((f>a||n<c)&&f<n-1){var r=k.fXaxis.GetBinLowEdge(f+1);var y=k.fXaxis.GetBinLowEdge(n+1);m=!0}if((t>d||l<b)&&t<l-1){var h=k.fYaxis.GetBinLowEdge(t+1);var x=k.fYaxis.GetBinLowEdge(l+1);m=!0}if((v>e||w<g)&&v<w-1){var B=k.fZaxis.GetBinLowEdge(v+1);var A=k.fZaxis.GetBinLowEdge(w+1);m=!0}m&&this.getFramePainter().zoom(r,y,h,x,B,A)}}};O.prototype.fillHistContextMenu=function(a){var c=this,d=g.getDrawSettings("ROOT."+this.getObject()._typename,"nosame");
a.addDrawMenu("Draw with",d.opts,function(a){if("inspect"===a)return c.showInspector();c.decodeOptions(a);c.interactiveRedraw(!0,"drawopt")})};g.drawHistogram3D=function(a,c,d){var b=new JSROOT.TH3Painter(a,c);return g.ensureTCanvas(b,"3d").then(function(){b.setAsMainPainter();b.decodeOptions(d);b.checkPadRange();b.scanContent();return b.redraw()}).then(function(){var c=b.createStat();if(c)return JSROOT.draw(a,c,"")}).then(function(){b.fillToolbar();return b})};ia.prototype=Object.create(JSROOT.ObjectPainter.prototype);
ia.prototype.decodeOptions=function(a){var c=new JSROOT.DrawOptions(a);this.options||(this.options={});var d=this.options;d.Color=c.check("COL");d.Line=c.check("LINE");d.Error=c.check("ERR")&&this.matchObjectType("TGraph2DErrors");d.Circles=c.check("P0");d.Markers=c.check("P");d.Markers||d.Error||d.Circles||d.Line||(d.Markers=!0);d.Markers||(d.Color=!1);this.storeDrawOpt(a)};ia.prototype.createHistogram=function(){for(var a=this.getObject(),c=a.fX[0],d=c,b=a.fY[0],e=b,g=a.fZ[0],m=g,u=0;u<a.fNpoints;++u){var p=
a.fX[u],k=a.fY[u],q=a.fZ[u],f=this.options.Error?a.fEX[u]:0,n=this.options.Error?a.fEY[u]:0,t=this.options.Error?a.fEZ[u]:0;c=Math.min(c,p-f);d=Math.max(d,p+f);b=Math.min(b,k-n);e=Math.max(e,k+n);g=Math.min(g,q-t);m=Math.max(m,q+t)}c>=d&&(d=c+1);b>=e&&(e=b+1);g>=m&&(m=g+1);u=.02*(d-c);k=.02*(e-b);f=.02*(m-g);a=c-u;u=d+u;p=b-k;k=e+k;q=g-f;f=m+f;0>a&&0<=c&&(a=.98*c);0<u&&0>=d&&(u=0);0>p&&0<=b&&(p=.98*b);0<k&&0>=e&&(k=0);0>q&&0<=g&&(q=.98*g);0<f&&0>=m&&(f=0);d=this.getObject();-1111!=d.fMinimum&&(q=
d.fMinimum);-1111!=d.fMaximum&&(f=d.fMaximum);c=JSROOT.createHistogram("TH2I",10,10);c.fName=d.fName+"_h";c.fTitle=d.fTitle;c.fXaxis.fXmin=a;c.fXaxis.fXmax=u;c.fYaxis.fXmin=p;c.fYaxis.fXmax=k;c.fZaxis.fXmin=q;c.fZaxis.fXmax=f;c.fMinimum=q;c.fMaximum=f;d=JSROOT.BIT(9);c.fBits|=d;return c};ia.prototype.graph2DTooltip=function(a){if(!Number.isInteger(a.index))return console.error("intersect.index not provided, three.js version "+e.REVISION+", expected 127"),null;var c=Math.floor(a.index/this.nvertex);
if(0>c||c>=this.index.length)return null;var d=function(a){return a*a};c=this.index[c];var b=this.painter,g=this.graph,n=b.grx(g.fX[c]),m=b.gry(g.fY[c]),u=b.grz(g.fZ[c]);if(this.check_next&&c+1<g.fX.length){a=a.point;var p=b.grx(g.fX[c+1]),k=b.gry(g.fY[c+1]),q=b.grz(g.fZ[c+1]);d(a.x-p)+d(a.y-k)+d(a.z-q)<d(a.x-n)+d(a.y-m)+d(a.z-u)&&(n=p,m=k,u=q,c++)}return{x1:n-this.scale0,x2:n+this.scale0,y1:m-this.scale0,y2:m+this.scale0,z1:u-this.scale0,z2:u+this.scale0,color:this.tip_color,lines:[this.tip_name,
"pnt: "+c,"x: "+b.axisAsText("x",g.fX[c]),"y: "+b.axisAsText("y",g.fY[c]),"z: "+b.axisAsText("z",g.fZ[c])]}};ia.prototype.redraw=function(){var a=this,c=this.getMainPainter(),d=this.getFramePainter(),b=this.getObject(),n=1;if(!(b&&c&&d&&d.mode3d))return Promise.resolve(this);var C=function(a,c){for(var e=0,f=0;f<b.fNpoints;++f)b.fX[f]<d.scale_xmin||b.fX[f]>d.scale_xmax||b.fY[f]<d.scale_ymin||b.fY[f]>d.scale_ymax||b.fZ[f]<a||b.fZ[f]>=c||++e;return e};if(0<JSROOT.settings.OptimizeDraw&&!d.webgl){var m=
C(d.scale_zmin,d.scale_zmax);5E4<m&&(n=Math.floor(m/5E4),2>=n&&(n=2))}var u=new JSROOT.TAttMarkerHandler(b);m=null;var p=[d.scale_zmin,d.scale_zmax],k=d.size_x3d/100*u.getFullSize();u=[];this.options.Circles&&(k=.06*d.size_x3d);d.usesvg&&(k*=.3);this.options.Color&&(p=c.getContourLevels(),m=c.getHistPalette());c={};for(var q=0;q<p.length-1;c={$jscomp$loop$prop$index$68:c.$jscomp$loop$prop$index$68},++q){var f=Math.max(p[q],d.scale_zmin),z=Math.min(p[q+1],d.scale_zmax);if(!(f>=z)){var t=Math.floor(C(f,
z)/n),l=null,v=0;c.$jscomp$loop$prop$index$68=new Int32Array(t);var w=0,r=null,y=null,h=0,x=0;if(this.options.Markers||this.options.Circles)l=new g.PointsCreator(t,d.webgl,k/3);this.options.Error&&(r=new Float32Array(18*t));this.options.Line&&(y=new Float32Array(6*(t-1)));for(t=0;t<b.fNpoints;++t)if(!(b.fX[t]<d.scale_xmin||b.fX[t]>d.scale_xmax||b.fY[t]<d.scale_ymin||b.fY[t]>d.scale_ymax||b.fZ[t]<f||b.fZ[t]>=z)){if(1<n&&(v=(v+1)%n,0!==v))continue;c.$jscomp$loop$prop$index$68[w++]=t;var B=d.grx(b.fX[t]),
A=d.gry(b.fY[t]),I=d.grz(b.fZ[t]);l&&l.addPoint(B,A,I);r&&(r[h]=d.grx(b.fX[t]-b.fEX[t]),r[h+1]=A,r[h+2]=I,r[h+3]=d.grx(b.fX[t]+b.fEX[t]),r[h+4]=A,r[h+5]=I,h+=6,r[h]=B,r[h+1]=d.gry(b.fY[t]-b.fEY[t]),r[h+2]=I,r[h+3]=B,r[h+4]=d.gry(b.fY[t]+b.fEY[t]),r[h+5]=I,h+=6,r[h]=B,r[h+1]=A,r[h+2]=d.grz(b.fZ[t]-b.fEZ[t]),r[h+3]=B,r[h+4]=A,r[h+5]=d.grz(b.fZ[t]+b.fEZ[t]),h+=6);y&&(6<=x&&(y[x]=y[x-3],y[x+1]=y[x-2],y[x+2]=y[x-1],x+=3),y[x]=B,y[x+1]=A,y[x+2]=I,x+=3)}y&&3<x&&y.length==x&&(f=this.getColor(this.getObject().fLineColor),
f=new e.LineBasicMaterial({color:new e.Color(f),linewidth:this.getObject().fLineWidth}),y=g.createLineSegments(y,f),d.toplevel.add(y),y.graph=b,y.index=c.$jscomp$loop$prop$index$68,y.painter=d,y.scale0=.7*k,y.tip_name=this.getObjectHint(),y.tip_color=3===b.fMarkerColor?16711680:65280,y.nvertex=2,y.check_next=!0,y.tooltip=this.graph2DTooltip);r&&(y=this.getColor(this.getObject().fLineColor),y=new e.LineBasicMaterial({color:new e.Color(y),linewidth:this.getObject().fLineWidth}),r=g.createLineSegments(r,
y),d.toplevel.add(r),r.graph=b,r.index=c.$jscomp$loop$prop$index$68,r.painter=d,r.scale0=.7*k,r.tip_name=this.getObjectHint(),r.tip_color=3===b.fMarkerColor?16711680:65280,r.nvertex=6,r.tooltip=this.graph2DTooltip);l&&(r="blue",this.options.Circles||(r=m?m.calcColor(q,p.length):this.getColor(b.fMarkerColor)),l=l.createPoints({color:r,style:this.options.Circles?4:b.fMarkerStyle,promise:!0}).then(function(c){return function(e){e.graph=b;e.painter=d;e.tip_color=3===b.fMarkerColor?16711680:65280;e.scale0=
.3*k;e.index=c.$jscomp$loop$prop$index$68;e.tip_name=a.getObjectHint();e.tooltip=a.graph2DTooltip;d.toplevel.add(e)}}(c)),u.push(l))}}return Promise.all(u).then(function(){d.render3D(100);return a})};g.drawGraph2D=function(a,c,d){var b=new JSROOT.TGraph2DPainter(a,c);b.decodeOptions(d);d=Promise.resolve(!0);b.getMainPainter()||(c.fHistogram||(c.fHistogram=b.createHistogram()),d=JSROOT.draw(a,c.fHistogram,"lego;axis"),b.ownhisto=!0);return d.then(function(){b.addToPadPrimitives();return b.redraw()})};
g.drawPolyMarker3D=function(){var a=this,c=this.getFramePainter();if(!c||!c.mode3d||!c.toplevel)return Promise.reject(Error("Fail to draw poly markers without 3D mode"));for(var d=1,b=0,n=this.getObject(),C=0;C<n.fP.length;C+=3)n.fP[C]<c.scale_xmin||n.fP[C]>c.scale_xmax||n.fP[C+1]<c.scale_ymin||n.fP[C+1]>c.scale_ymax||n.fP[C+2]<c.scale_zmin||n.fP[C+2]>c.scale_zmax||++b;0<JSROOT.settings.OptimizeDraw&&5E4<b&&(d=Math.floor(b/5E4),2>=d&&(d=2));b=Math.floor(b/d);for(var m=new g.PointsCreator(b,c.webgl,
c.size_x3d/100),u=new Int32Array(b),p=C=b=0;p<n.fP.length;p+=3)if(!(n.fP[p]<c.scale_xmin||n.fP[p]>c.scale_xmax||n.fP[p+1]<c.scale_ymin||n.fP[p+1]>c.scale_ymax||n.fP[p+2]<c.scale_zmin||n.fP[p+2]>c.scale_zmax)){if(1<d&&(b=(b+1)%d,0!==b))continue;u[C++]=p;m.addPoint(c.grx(n.fP[p]),c.gry(n.fP[p+1]),c.grz(n.fP[p+2]))}return m.createPoints({color:this.getColor(n.fMarkerColor),style:n.fMarkerStyle,promise:!0}).then(function(b){b.tip_color=3===n.fMarkerColor?16711680:65280;b.tip_name=n.fName||"Poly3D";b.poly=
n;b.painter=c;b.scale0=.7*m.scale;b.index=u;c.toplevel.add(b);b.tooltip=function(a){if(!Number.isInteger(a.index))return console.error("intersect.index not provided, three.js version "+e.REVISION+", expected 127"),null;a=Math.floor(a.index/this.nvertex);if(0>a||a>=this.index.length)return null;a=this.index[a];var b=this.painter,c=b.grx(this.poly.fP[a]),d=b.gry(this.poly.fP[a+1]),g=b.grz(this.poly.fP[a+2]);return{x1:c-this.scale0,x2:c+this.scale0,y1:d-this.scale0,y2:d+this.scale0,z1:g-this.scale0,
z2:g+this.scale0,color:this.tip_color,lines:[this.tip_name,"pnt: "+a/3,"x: "+b.axisAsText("x",this.poly.fP[a]),"y: "+b.axisAsText("y",this.poly.fP[a+1]),"z: "+b.axisAsText("z",this.poly.fP[a+2])]}};c.render3D(100);return a})};JSROOT.TH3Painter=O;JSROOT.TGraph2DPainter=ia;return JSROOT});
